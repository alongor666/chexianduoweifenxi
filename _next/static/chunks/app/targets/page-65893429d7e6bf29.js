(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[573],{56623:function(e,t,s){Promise.resolve().then(s.bind(s,41576))},41576:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ec}});var n=s(36059),a=s(90616),r=s(28406),i=s(44206),l=s(41405),c=s(42030),d=s(66066),o=s(68464),u=s(8798),m=s(5379),h=s(60373);let x=[{bizType:"10吨以上-普货",annualTarget:450},{bizType:"10吨以上-牵引",annualTarget:2100},{bizType:"1吨以上非营业货车",annualTarget:1e3},{bizType:"1吨以下非营业货车",annualTarget:1600},{bizType:"2-9吨营业货车",annualTarget:600},{bizType:"2吨以下营业货车",annualTarget:1500},{bizType:"9-10吨营业货车",annualTarget:250},{bizType:"出租车",annualTarget:100},{bizType:"非营业客车旧车非过户",annualTarget:27e3},{bizType:"非营业客车旧车过户车",annualTarget:4e3},{bizType:"非营业客车新车",annualTarget:1400},{bizType:"摩托车",annualTarget:1700},{bizType:"其他",annualTarget:100},{bizType:"特种车",annualTarget:100},{bizType:"网约车",annualTarget:300},{bizType:"自卸",annualTarget:900}],p=e=>g(e).map(e=>({bizType:e,annualTarget:1e3})),g=e=>{switch(e){case"businessType":return["车险整体",...h.p7];case"thirdLevelOrganization":return h.W4;case"customerCategory":return h.iZ;case"insuranceType":return h.Xs;default:return[]}},b="".concat(2025,"-年初目标"),j=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"businessType",t="businessType"===e?x:p(e);return{id:b,type:"INIT",createdAt:new Date("".concat(2025,"-01-01T00:00:00.000Z")).toISOString(),locked:!0,rows:t.map(e=>({bizType:e.bizType,annualTargetInit:e.annualTarget,annualTargetTuned:e.annualTarget}))}},v=e=>{let t={};return e.rows.forEach(e=>{t[e.bizType]=0}),t},f=()=>{let e=j("businessType"),t={businessType:{versions:[e],currentVersionId:b,achievedMap:v(e)},thirdLevelOrganization:{versions:[j("thirdLevelOrganization")],currentVersionId:b,achievedMap:v(j("thirdLevelOrganization"))},customerCategory:{versions:[j("customerCategory")],currentVersionId:b,achievedMap:v(j("customerCategory"))},insuranceType:{versions:[j("insuranceType")],currentVersionId:b,achievedMap:v(j("insuranceType"))}};return{baseYear:2025,versions:[e],currentVersionId:b,achievedMap:v(e),currentDimension:"businessType",dimensionData:t}},y=e=>({currentVersionId:e.currentVersionId,versions:e.versions.map(e=>({...e,rows:e.rows.map(e=>({...e}))})),currentDimension:e.currentDimension,dimensionData:Object.fromEntries(Object.entries(e.dimensionData).map(e=>{let[t,s]=e;return[t,{...s,versions:s.versions.map(e=>({...e,rows:e.rows.map(e=>({...e}))}))}]}))}),N=e=>({currentVersionId:e.currentVersionId,versions:e.versions.map(e=>({...e,rows:e.rows.map(e=>({...e}))})),currentDimension:e.currentDimension,dimensionData:Object.fromEntries(Object.entries(e.dimensionData).map(e=>{let[t,s]=e;return[t,{...s,versions:s.versions.map(e=>({...e,rows:e.rows.map(e=>({...e}))}))}]}))}),T=(e,t,s)=>{let n="".concat(s.getFullYear()).concat("".concat(s.getMonth()+1).padStart(2,"0")).concat("".concat(s.getDate()).padStart(2,"0")),a="".concat(t,"-微调目标-").concat(n),r=a,i=2;for(;e.some(e=>e.id===r);)r="".concat(a,"_#").concat(i),i+=1;return r},w=e=>{let t=["业务类型,年度目标（万）"];return e.rows.forEach(s=>{let n="INIT"===e.type?s.annualTargetInit:s.annualTargetTuned;t.push("".concat(s.bizType,",").concat(n))}),"".concat(t.join("\n"),"\n")},k=x.map(e=>e.bizType),z=(0,u.U)()((0,m.mW)((e,t)=>({...f(),getInitialVersion:()=>{let{versions:e}=t(),s=e.find(e=>"INIT"===e.type);if(!s)throw Error("缺少年初目标版本，请检查初始化数据");return s},getCurrentVersion:()=>{let{versions:e,currentVersionId:s}=t(),n=e.find(e=>e.id===s);if(!n)throw Error("当前版本不存在，请重新选择版本");return n},setAchievedMap:t=>{e(e=>({achievedMap:{...e.achievedMap,...t}}))},updateAchievedValue:(t,s)=>{e(e=>({achievedMap:{...e.achievedMap,[t]:s}}))},switchVersion:t=>{e(e=>e.versions.some(e=>e.id===t)?{...e,currentVersionId:t}:e)},createTunedVersion:function(s){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,a=t(),r=a.versions.find(e=>"INIT"===e.type);if(!r)throw Error("缺少年初目标版本，无法创建微调目标");let i=new Map(s.map(e=>[e.bizType,e.annualTarget])),l=r.rows.filter(e=>!i.has(e.bizType)).map(e=>e.bizType);if(l.length>0)throw Error("导入失败，缺少以下业务类型：".concat(l.join("、")));let c=s.filter(e=>"车险整体"!==e.bizType).reduce((e,t)=>e+t.annualTarget,0),d=s.map(e=>"车险整体"===e.bizType?{...e,annualTarget:c}:e),o=r.rows.map(e=>{let t=d.find(t=>t.bizType===e.bizType);return{bizType:e.bizType,annualTargetInit:e.annualTargetInit,annualTargetTuned:t?t.annualTarget:e.annualTargetTuned}}),u=N(a),m=T(a.versions,a.baseYear,n),h={id:m,type:"TUNED",createdAt:n.toISOString(),locked:!1,rows:o};return e({versions:[...a.versions,h],currentVersionId:m,achievedMap:{...a.achievedMap},history:[...a.history,y(u)]}),{versionId:m}},exportVersionCsv:e=>{let{versions:s}=t(),n=s.find(t=>t.id===e);if(!n)throw Error("未找到指定版本：".concat(e));return w(n)},exportCurrentVersionCsv:()=>{let{currentVersionId:e}=t();return t().exportVersionCsv(e)},undo:()=>{e(e=>{if(0===e.history.length)return e;let t=e.history[e.history.length-1];return{...e,...t,history:e.history.slice(0,-1)}})},switchDimension:t=>{e(e=>{let s=e.dimensionData[t];return{...e,currentDimension:t,versions:s.versions,currentVersionId:s.currentVersionId,achievedMap:s.achievedMap}})},getDimensionItems:e=>g(e)})));var M=s(76066),C=s(13344),I=s(26992),V=s(11864),O=s(45860),E=s(48134);function D(e){let{className:t}=e,{getCurrentVersion:s,achievedMap:r,createTunedVersion:i,currentDimension:l}=z(),{filters:u,selectedYear:m}=(0,M.a)(),[h,x]=(0,a.useState)({}),p=(0,a.useRef)({}),g=s(),b=(0,a.useCallback)(e=>e,[]),j=(0,a.useMemo)(()=>u.singleModeWeek&&m?365-Math.floor(365*(0,E.$)(u.singleModeWeek,m)):null,[u.singleModeWeek,m]),v=(0,a.useCallback)(e=>{var t;let s=g.rows.find(t=>t.bizType===e);if(!s)return{itemKey:e,itemLabel:b(e),annualTargetInit:0,annualTargetTuned:0,achieved:0,initialAchievementRate:null,tunedAchievementRate:null,initialGap:0,tunedGap:0,shareOfTotal:0,annualGap:0,dailyGapForRemaining:null};let n=r[e]||0,a=null!==(t=h[e])&&void 0!==t?t:s.annualTargetTuned,i=s.annualTargetInit>0?n/s.annualTargetInit*100:null,l=s.annualTargetInit-n,c=g.rows.reduce((e,t)=>e+t.annualTargetTuned,0),d=a-n,o=j&&j>0?d/j:null;return{itemKey:e,itemLabel:b(e),annualTargetInit:s.annualTargetInit,annualTargetTuned:a,achieved:n,initialAchievementRate:i,tunedAchievementRate:a>0?n/a*100:null,initialGap:l,tunedGap:a-n,shareOfTotal:c>0?a/c*100:0,annualGap:d,dailyGapForRemaining:o}},[g.rows,r,h,b,j]),f=(0,a.useMemo)(()=>"businessType"!==l?g.rows.reduce((e,t)=>{var s;return e+(null!==(s=h[t.bizType])&&void 0!==s?s:t.annualTargetTuned)},0):g.rows.filter(e=>"车险整体"!==e.bizType).reduce((e,t)=>{var s;return e+(null!==(s=h[t.bizType])&&void 0!==s?s:t.annualTargetTuned)},0),[g.rows,h,l]),y=(0,a.useMemo)(()=>{let e=[];return g.rows.forEach(t=>{let s=h[t.bizType];if(void 0!==s&&("businessType"!==l||"车险整体"!==t.bizType)){let n=100*Math.abs((s-t.annualTargetTuned)/t.annualTargetTuned);n>50&&e.push({type:"warning",message:"".concat(b(t.bizType),"目标变化幅度过大：").concat(n.toFixed(1),"%")})}}),e},[g.rows,h,l,b]),N=e=>null===e?"safe":e<70?"danger":e<85?"warning":"safe",T=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s="transition-all duration-200";if(t)return"".concat(s," bg-blue-50 border-l-4 border-blue-400");switch(e){case"danger":return"".concat(s," bg-red-50 border-l-4 border-red-400");case"warning":return"".concat(s," bg-yellow-50 border-l-4 border-yellow-400");default:return s}},w=(0,a.useCallback)((e,t)=>{if("ArrowUp"===e.key||"ArrowDown"===e.key){e.preventDefault();let s=Object.keys(p.current).filter(e=>null!==p.current[e]).sort(),n=s.indexOf(t);if(-1!==n){let t;t="ArrowUp"===e.key?n>0?n-1:s.length-1:n<s.length-1?n+1:0;let a=p.current[s[t]];a&&(a.focus(),a.select())}}else if("Enter"===e.key||"Tab"===e.key){e.preventDefault();let s=Object.keys(p.current).filter(e=>null!==p.current[e]).sort(),n=s.indexOf(t);if(-1!==n){let e=n<s.length-1?n+1:0,t=p.current[s[e]];t&&(t.focus(),t.select())}}},[]),k=(0,a.useMemo)(()=>g.rows.map(e=>v(e.bizType)),[g.rows,v]),D="businessType"===l?k.find(e=>"车险整体"===e.itemKey):null,R="businessType"===l?k.filter(e=>"车险整体"!==e.itemKey):k;return(0,n.jsxs)(c.Zb,{className:(0,I.cn)("w-full",t),children:[(0,n.jsx)(c.Ol,{children:(0,n.jsx)(c.ll,{children:"目标设定与达成情况"})}),(0,n.jsxs)(c.aY,{children:[y.length>0&&(0,n.jsx)("div",{className:"mb-4 space-y-2",children:y.map((e,t)=>(0,n.jsxs)("div",{className:(0,I.cn)("flex items-center gap-2 p-3 rounded-md text-sm","error"===e.type?"bg-red-50 text-red-700 border border-red-200":"bg-yellow-50 text-yellow-700 border border-yellow-200"),children:[(0,n.jsx)(o.Z,{className:"h-4 w-4 flex-shrink-0"}),(0,n.jsx)("span",{children:e.message})]},t))}),(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsxs)("table",{className:"w-full border-collapse",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{className:"border-b bg-gray-50",children:[(0,n.jsx)("th",{className:"text-left p-3 font-medium",children:"businessType"===l?"业务类型":"thirdLevelOrganization"===l?"三级机构":"customerCategory"===l?"客户类型":"保险类型"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"年初目标"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"调优目标"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"已达成"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"年初达成率"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"调优达成率"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"年目标缺口"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"日均缺口"}),(0,n.jsx)("th",{className:"text-right p-3 font-medium",children:"占比"})]})}),(0,n.jsxs)("tbody",{children:[D&&(0,n.jsxs)("tr",{className:"border-b bg-blue-50 font-medium",children:[(0,n.jsx)("td",{className:"p-3 font-semibold text-blue-600",children:D.itemLabel}),(0,n.jsx)("td",{className:"text-right p-3 font-semibold",children:(0,V.uf)(D.annualTargetInit)}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,n.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,n.jsx)("span",{className:"text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded",children:"自动计算"}),(0,n.jsx)("span",{className:"font-semibold text-blue-600",children:(0,V.uf)(f)})]})}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,V.uf)(D.achieved)}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==D.initialAchievementRate&&(0,n.jsxs)("span",{className:(0,O.qB)(D.initialAchievementRate/100).text,children:[D.initialAchievementRate.toFixed(1),"%"]})}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==D.tunedAchievementRate&&(0,n.jsxs)("span",{className:(0,O.qB)(D.tunedAchievementRate/100).text,children:[D.tunedAchievementRate.toFixed(1),"%"]})}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,n.jsx)("span",{className:D.annualGap>0?"text-red-500":"text-green-500",children:(0,V.uf)(D.annualGap)})}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==D.dailyGapForRemaining?(0,n.jsx)("span",{className:D.dailyGapForRemaining>0?"text-red-500":"text-green-500",children:(0,V.uf)(D.dailyGapForRemaining)}):(0,n.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,n.jsxs)("td",{className:"text-right p-3",children:[D.shareOfTotal.toFixed(1),"%"]})]}),R.map(e=>{var t;let s=N(e.tunedAchievementRate),a=void 0!==h[e.itemKey];return(0,n.jsxs)("tr",{className:(0,I.cn)("border-b hover:bg-gray-50",T(s,a)),children:[(0,n.jsxs)("td",{className:"p-3 flex items-center gap-2",children:[("danger"===s||"warning"===s)&&(0,n.jsx)(o.Z,{className:(0,I.cn)("h-4 w-4",{"text-red-500":"danger"===s,"text-yellow-500":"warning"===s})}),(0,n.jsx)("span",{className:"font-medium",children:e.itemLabel})]}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,V.uf)(e.annualTargetInit)}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,n.jsx)(C.I,{ref:t=>{p.current[e.itemKey]=t},type:"number",value:null!==(t=h[e.itemKey])&&void 0!==t?t:e.annualTargetTuned,onChange:t=>{let s=t.target.value.replace(/[^0-9]/g,""),n=""===s?0:parseInt(s,10);x(t=>({...t,[e.itemKey]:n}))},onKeyDown:t=>w(t,e.itemKey),className:"w-24 text-right text-sm",step:"1"})}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,V.uf)(e.achieved)}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==e.initialAchievementRate&&(0,n.jsxs)("span",{className:(0,O.qB)(e.initialAchievementRate/100).text,children:[e.initialAchievementRate.toFixed(1),"%"]})}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==e.tunedAchievementRate&&(0,n.jsxs)("span",{className:(0,O.qB)(e.tunedAchievementRate/100).text,children:[e.tunedAchievementRate.toFixed(1),"%"]})}),(0,n.jsx)("td",{className:"text-right p-3",children:(0,n.jsx)("span",{className:e.annualGap>0?"text-red-500":"text-green-500",children:(0,V.uf)(e.annualGap)})}),(0,n.jsx)("td",{className:"text-right p-3",children:null!==e.dailyGapForRemaining?(0,n.jsx)("span",{className:e.dailyGapForRemaining>0?"text-red-500":"text-green-500",children:(0,V.uf)(e.dailyGapForRemaining)}):(0,n.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,n.jsxs)("td",{className:"text-right p-3",children:[e.shareOfTotal.toFixed(1),"%"]})]},e.itemKey)})]})]})}),Object.keys(h).length>0&&(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)(d.z,{variant:"outline",onClick:()=>x({}),children:"取消"}),(0,n.jsx)(d.z,{onClick:()=>{let e=g.rows.map(e=>{let t=h[e.bizType];return void 0!==t&&("businessType"!==l||"车险整体"!==e.bizType)?{...e,annualTargetTuned:t}:e});if("businessType"===l){let t=e.filter(e=>"车险整体"!==e.bizType).reduce((e,t)=>e+t.annualTargetTuned,0);i(e.map(e=>"车险整体"===e.bizType?{...e,annualTargetTuned:t}:e))}else i(e);x({})},children:"应用更改"})]})]})]})}var R=s(12162),A=s(11789),S=s(8254),_=s(49979),Z=s(37027),L=s(65577),W=s(61950),F=s(94258),U=s(61511),G=s(87123),Y=s(95138),B=s.n(Y);class K extends Error{constructor(e,t){super(e),this.issues=t,this.name="GoalCsvParseError"}}let q=["业务类型","年度目标（万）"];async function P(e,t){return function(e,t){let s=B().parse(e,{header:!0,skipEmptyLines:!0,transformHeader:e=>e.trim()}),n=[...function(e){let t=[];if(!e)return[{type:"MISSING_COLUMN",message:"CSV（逗号分隔值）缺少表头，无法识别字段"}];for(let s of q)e.includes(s)||t.push({type:"MISSING_COLUMN",message:"缺少必填列：".concat(s)});return t}(s.meta.fields)],a=[],r=new Set,i=0;if(s.data.forEach((e,s)=>{var l,c,d,o;let u=s+2,m=null!==(d=null===(l=e["业务类型"])||void 0===l?void 0:l.trim())&&void 0!==d?d:"",h=null!==(o=null===(c=e["年度目标（万）"])||void 0===c?void 0:c.trim())&&void 0!==o?o:"";if(!m){n.push({type:"EMPTY_VALUE",message:"业务类型不能为空",rowIndex:u});return}if(r.has(m)){n.push({type:"DUPLICATE_BIZ_TYPE",message:"重复的业务类型：".concat(m),rowIndex:u,bizType:m});return}if(r.add(m),!h){n.push({type:"EMPTY_VALUE",message:"业务类型 ".concat(m," 的年度目标（万）不能为空"),rowIndex:u,bizType:m});return}let x=Number(h);if(!Number.isFinite(x)){n.push({type:"NON_NUMERIC",message:"业务类型 ".concat(m," 的年度目标（万）必须为数字"),rowIndex:u,bizType:m,rawValue:h});return}if(x<0){n.push({type:"NEGATIVE_VALUE",message:"业务类型 ".concat(m," 的年度目标（万）不能为负数"),rowIndex:u,bizType:m,rawValue:h});return}let{knownBusinessTypes:p,unknownBusinessStrategy:g="block"}=t;if(!p.includes(m)){if("ignore"===g){i+=1;return}n.push({type:"UNKNOWN_BIZ_TYPE",message:"未知业务类型：".concat(m),rowIndex:u,bizType:m});return}a.push({bizType:m,annualTarget:x})}),n.length>0)throw new K("CSV（逗号分隔值）导入失败",n);return{success:!0,data:a,issues:[],rows:a,ignoredUnknownCount:i}}(await e.text(),t)}function X(){let[e,t]=(0,a.useState)(!1),[s,r]=(0,a.useState)([]),[i,l]=(0,a.useState)(!1),[o,u]=(0,a.useState)(0),m=z(e=>e.createTunedVersion),h=z(e=>e.exportCurrentVersionCsv),x=z(e=>e.getCurrentVersion),p=z(e=>e.baseYear),g=z(e=>e.versions),b=z(e=>e.currentVersionId),j=z(e=>e.switchVersion),{toast:v}=(0,G.pm)(),f=(0,a.useCallback)(()=>{let e=k.map(e=>"".concat(e,",0")),t=new Blob(["业务类型,年度目标（万）\n".concat(e.join("\n"),"\n")],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="目标导入模板_".concat(p,".csv"),n.click(),URL.revokeObjectURL(s),v({title:"模板下载成功",description:"已生成模板文件：目标导入模板_".concat(p,".csv")})},[p,v]),y=(0,a.useCallback)(async e=>{if(0===e.length)return;t(!0),r([]),u(0);let s=e[0];try{let{rows:e,ignoredUnknownCount:t}=await P(s,{knownBusinessTypes:k,unknownBusinessStrategy:"block"}),{versionId:n}=m(e||[]);u(t||0),v({title:"导入成功",description:"已创建新版本：".concat(n)})}catch(e){e instanceof K?(r(e.issues),l(!0)):v({title:"导入失败",description:e instanceof Error?e.message:"未知错误",variant:"destructive"})}finally{t(!1)}},[m,v]),{getRootProps:N,getInputProps:T,isDragActive:w,fileRejections:M}=(0,R.uI)({onDrop:y,accept:{"text/csv":[".csv"],"application/vnd.ms-excel":[".csv"]},maxFiles:1,disabled:e}),C=(0,a.useMemo)(()=>{if(0===M.length)return null;let e=M[0];return(0,n.jsxs)(F.bZ,{className:"mt-3",variant:"destructive",children:[(0,n.jsx)(F.Cd,{children:"文件格式错误"}),(0,n.jsx)(F.X,{children:e.errors.map(e=>e.message).join("，")})]})},[M]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(c.Zb,{children:[(0,n.jsx)(c.Ol,{children:(0,n.jsxs)(c.ll,{className:"flex items-center gap-2",children:[(0,n.jsx)(A.Z,{className:"h-5 w-5"}),"目标管理操作"]})}),(0,n.jsxs)(c.aY,{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:"数据导入导出"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{...N({className:(0,I.cn)("flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-muted-foreground/30 p-4 text-center transition-colors cursor-pointer",w&&"border-primary bg-primary/5",e&&"pointer-events-none opacity-60")}),children:[(0,n.jsx)("input",{...T(),"aria-label":"上传 CSV 文件"}),(0,n.jsx)(S.Z,{className:"mb-2 h-6 w-6 text-primary","aria-hidden":"true"}),(0,n.jsx)("p",{className:"text-sm font-medium",children:"拖拽或点击上传 CSV 文件"}),(0,n.jsx)("p",{className:"mt-1 text-xs text-muted-foreground",children:"支持业务类型、年度目标数据导入"})]}),C,(0,n.jsxs)(d.z,{onClick:f,variant:"outline",size:"sm",className:"w-full",children:[(0,n.jsx)(_.Z,{className:"h-4 w-4 mr-2"}),"下载导入模板"]})]}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center rounded-lg border border-muted-foreground/30 p-4 text-center bg-muted/20",children:[(0,n.jsx)(_.Z,{className:"mb-2 h-6 w-6 text-primary"}),(0,n.jsx)("p",{className:"text-sm font-medium",children:"导出当前目标数据"}),(0,n.jsx)("p",{className:"mt-1 text-xs text-muted-foreground",children:"导出为 CSV 格式文件"})]}),(0,n.jsxs)(d.z,{onClick:()=>{try{let e=h(),t=x(),s=new Date,n="".concat(s.getFullYear()).concat("".concat(s.getMonth()+1).padStart(2,"0")).concat("".concat(s.getDate()).padStart(2,"0")),a="".concat(t.id,"_").concat(n,".csv"),r=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(r),l=document.createElement("a");l.href=i,l.download=a,l.click(),URL.revokeObjectURL(i),v({title:"导出成功",description:"文件已生成：".concat(a)})}catch(e){v({title:"导出失败",description:e instanceof Error?e.message:"未知错误",variant:"destructive"})}},variant:"outline",size:"sm",className:"w-full",children:[(0,n.jsx)(_.Z,{className:"h-4 w-4 mr-2"}),"导出当前版本"]})]})]})]}),(0,n.jsx)("div",{className:"border-t pt-4"}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:"目标管理操作"}),(0,n.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,n.jsxs)(d.z,{onClick:()=>{v({title:"保存成功",description:"目标数据已保存到本地存储"})},variant:"default",size:"sm",children:[(0,n.jsx)(Z.Z,{className:"h-4 w-4 mr-2"}),"保存"]}),(0,n.jsxs)(d.z,{onClick:()=>{v({title:"确认成功",description:"当前目标版本已确认"})},variant:"default",size:"sm",children:[(0,n.jsx)(L.Z,{className:"h-4 w-4 mr-2"}),"确认"]}),(0,n.jsxs)(d.z,{variant:"outline",size:"sm",children:[(0,n.jsx)(W.Z,{className:"h-4 w-4 mr-2"}),"修改记录"]}),(0,n.jsx)(d.z,{variant:"outline",size:"sm",children:"版本管理"})]})]}),g.length>1&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"border-t pt-4"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:"版本历史"}),(0,n.jsx)("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:g.map(e=>(0,n.jsxs)("div",{className:(0,I.cn)("flex items-center justify-between p-2 rounded border text-sm",e.id===b?"bg-primary/10 border-primary/30":"bg-muted/20 border-muted-foreground/20"),children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"font-medium",children:"INIT"===e.type?"初始":"调整"}),(0,n.jsx)("span",{className:"text-muted-foreground ml-2",children:new Date(e.createdAt).toLocaleDateString()})]}),e.id!==b&&(0,n.jsx)(d.z,{onClick:()=>j(e.id),variant:"ghost",size:"sm",children:"切换"})]},e.id))})]})]})]})]}),(0,n.jsx)(U.Vq,{open:i,onOpenChange:l,children:(0,n.jsxs)(U.cZ,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[(0,n.jsx)(U.fK,{children:(0,n.jsx)(U.$N,{children:"CSV 导入错误"})}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("p",{className:"text-sm text-muted-foreground",children:["发现 ",s.length," 个问题，请修正后重新导入："]}),(0,n.jsx)("div",{className:"space-y-2",children:s.map((e,t)=>(0,n.jsx)(F.bZ,{variant:"destructive",children:(0,n.jsxs)(F.X,{children:[e.rowIndex&&"第 ".concat(e.rowIndex," 行："),e.message,e.bizType&&" (业务类型: ".concat(e.bizType,")"),e.rawValue&&" (原始值: ".concat(e.rawValue,")")]})},t))})]})]})})]})}let $=[{value:"businessType",label:"业务类型"},{value:"thirdLevelOrganization",label:"三级机构"},{value:"customerCategory",label:"客户类型"},{value:"insuranceType",label:"保险类型"}];function H(e){let{selectedDimension:t,onDimensionChange:s,className:a=""}=e;return(0,n.jsxs)("div",{className:"flex items-center gap-2 ".concat(a),children:[(0,n.jsx)("span",{className:"text-sm font-medium text-slate-700",children:"目标维度:"}),(0,n.jsx)("div",{className:"flex gap-2",children:$.map(e=>(0,n.jsx)("button",{className:"px-3 py-1 text-sm rounded-full border transition-colors cursor-pointer ".concat(t===e.value?"bg-blue-600 text-white border-blue-600":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"),onClick:()=>s(e.value),children:e.label},e.value))})]})}var J=s(18661),Q=s(33955),ee=s(76910),et=s(27078),es=s(32522),en=s(57040);function ea(e){let{availableWeeks:t}=e,{viewMode:s}=(0,et.qr)(),r=(0,es.r)(e=>e.filters),i=(0,es.r)(e=>e.updateFilters),l=(0,et.qr)(e=>e.updateFilters),[c,o]=(0,a.useState)(!1),u=e=>{i(e),l(e)},m="single"===s,h=m?null!=r.singleModeWeek?[r.singleModeWeek]:[]:r.trendModeWeeks,x=e=>{u({singleModeWeek:e,weeks:[e]}),o(!1)},p=e=>{let t=r.trendModeWeeks.includes(e),s=t?r.trendModeWeeks.filter(t=>t!==e):[...r.trendModeWeeks,e].sort((e,t)=>e-t);if(t){u({trendModeWeeks:s,weeks:s});return}u({trendModeWeeks:s,weeks:s})};return(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("label",{className:"text-xs text-slate-600",children:["周序号 ",m?"(单选)":"(多选)"]}),h.length>0&&(0,n.jsxs)(d.z,{variant:"ghost",size:"sm",onClick:()=>u(m?{singleModeWeek:null,weeks:[]}:{trendModeWeeks:[],weeks:[]}),className:"h-auto p-1 text-xs text-slate-500 hover:text-slate-700",children:[(0,n.jsx)(J.Z,{className:"w-3 h-3 mr-1"}),"清空"]})]}),(0,n.jsxs)(en.J2,{open:c,onOpenChange:o,children:[(0,n.jsx)(en.xo,{asChild:!0,children:(0,n.jsxs)(d.z,{variant:"outline",role:"combobox","aria-expanded":c,className:"w-full justify-between text-left font-normal",children:[(0,n.jsx)("span",{className:"truncate",children:0===h.length?m?"选择分析周":"选择分析周（多选）":m||1===h.length?"W".concat(h[0]):h.length===t.length?"全部周次":"已选 ".concat(h.length," / ").concat(t.length," 周")}),(0,n.jsx)(Q.Z,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,n.jsxs)(en.yk,{className:"w-80 p-0",align:"start",children:[!m&&(0,n.jsxs)("div",{className:"border-b border-slate-200 p-3",children:[(0,n.jsx)("div",{className:"flex items-center justify-between text-xs text-slate-600 mb-2",children:(0,n.jsxs)("span",{children:["已选 ",h.length," / ",t.length," 周"]})}),(0,n.jsxs)("div",{className:"flex gap-1",children:[(0,n.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{let e=t.map(e=>e.week);u({trendModeWeeks:e,weeks:e})},className:"h-7 px-2 text-xs",children:"全选"}),(0,n.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{let e=t.map(e=>e.week).filter(e=>!r.trendModeWeeks.includes(e));i({trendModeWeeks:e,weeks:e})},className:"h-7 px-2 text-xs",children:"反选"}),(0,n.jsx)(d.z,{variant:"ghost",size:"sm",onClick:()=>{u({trendModeWeeks:[],weeks:[]})},className:"h-7 px-2 text-xs",children:"清空"})]})]}),(0,n.jsx)("div",{className:"max-h-60 overflow-y-auto",children:m?(0,n.jsx)("div",{className:"p-3",children:(0,n.jsx)("div",{className:"grid grid-cols-4 gap-2",children:t.map(e=>(0,n.jsx)(d.z,{variant:h.includes(e.week)?"default":"outline",size:"sm",onClick:()=>x(e.week),className:"h-8 text-xs",children:e.label},e.week))})}):(0,n.jsx)("div",{className:"p-1",children:t.map(e=>{let t=h.includes(e.week);return(0,n.jsxs)("div",{className:(0,I.cn)("flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-slate-50 rounded-md",t&&"bg-blue-50 text-blue-900"),onClick:()=>p(e.week),children:[(0,n.jsx)("div",{className:(0,I.cn)("w-4 h-4 border rounded flex items-center justify-center",t?"bg-blue-600 border-blue-600 text-white":"border-slate-300"),children:t&&(0,n.jsx)(ee.Z,{className:"w-3 h-3"})}),(0,n.jsx)("span",{className:"flex-1",children:e.label})]},e.week)})})}),(0,n.jsx)("div",{className:"border-t border-slate-200 p-3 bg-slate-50",children:(0,n.jsx)("div",{className:"text-xs text-slate-600",children:m?(0,n.jsx)("span",{children:"\uD83D\uDCA1 单周模式：选择一个周进行深度分析"}):(0,n.jsx)("span",{children:"\uD83D\uDCA1 多周模式：选择多个周观察趋势变化"})})})]})]})]})}var er=s(62658),ei=s(97830);function el(e){return null===e?"—":"".concat((100*e).toFixed(2),"%")}function ec(){let e=(0,r.useRouter)(),{rawData:t}=(0,er._V)(),{filters:s,updateFilters:o}=(0,M.a)(),u=z(e=>e.setAchievedMap),m=z(e=>e.getInitialVersion()),h=z(e=>e.getCurrentVersion()),x=z(e=>e.achievedMap),p=z(e=>e.currentDimension),g=z(e=>e.switchDimension);(0,a.useEffect)(()=>{o({viewMode:"single"})},[o]);let b=(0,a.useMemo)(()=>{let e=new Set;return t.forEach(t=>{t.week_number&&e.add(t.week_number)}),Array.from(e).sort((e,t)=>e-t).map(e=>({label:"W".concat(e),value:"".concat(e),week:e}))},[t]),j=(0,a.useMemo)(()=>{let e=new Map,n=s.singleModeWeek;(n?t.filter(e=>e.week_number===n):[]).forEach(t=>{var s;let n=(0,ei.Vd)(t.business_type_category);if(!n)return;let a=null!==(s=e.get(n))&&void 0!==s?s:0;e.set(n,a+t.signed_premium_yuan)});let a={};return m.rows.forEach(t=>{var s;let n=(0,ei.Vd)(t.bizType),r=null!==(s=e.get(n))&&void 0!==s?s:0;a[t.bizType]=Number((r/1e4).toFixed(2))}),a},[m,t,s.singleModeWeek]);(0,a.useEffect)(()=>{u(j)},[j,u]);let v=(0,a.useMemo)(()=>m.rows.reduce((e,t)=>e+t.annualTargetInit,0),[m]),f=(0,a.useMemo)(()=>h.rows.reduce((e,t)=>e+t.annualTargetTuned,0),[h]),y=(0,a.useMemo)(()=>Object.values(x).reduce((e,t)=>e+t,0),[x]);return(0,n.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100",children:(0,n.jsxs)("div",{className:"container mx-auto px-4 py-6 space-y-6",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsxs)(d.z,{variant:"ghost",size:"sm",onClick:()=>e.push("/"),className:"text-slate-600 hover:text-slate-900",children:[(0,n.jsx)(i.Z,{className:"h-4 w-4 mr-2"}),"返回主页"]}),(0,n.jsx)("h1",{className:"text-2xl font-bold text-slate-900",children:"目标管理"})]}),(0,n.jsx)(l.B,{active:"targets",onChange:t=>{"targets"!==t&&e.push("kpi"===t?"/":"/?tab=".concat(t))}}),(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,n.jsxs)(c.Zb,{children:[(0,n.jsx)(c.Ol,{children:(0,n.jsx)(c.ll,{children:"目标维度"})}),(0,n.jsx)(c.aY,{children:(0,n.jsx)(H,{selectedDimension:p,onDimensionChange:g})})]}),(0,n.jsxs)(c.Zb,{children:[(0,n.jsx)(c.Ol,{children:(0,n.jsx)(c.ll,{children:"分析周次"})}),(0,n.jsx)(c.aY,{children:(0,n.jsx)(ea,{availableWeeks:b})})]})]}),(0,n.jsxs)("div",{className:"grid gap-6",children:[(0,n.jsxs)(c.Zb,{children:[(0,n.jsx)(c.Ol,{children:(0,n.jsx)(c.ll,{children:"目标概览"})}),(0,n.jsx)(c.aY,{children:(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[(0,n.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,n.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"初始目标总额"}),(0,n.jsxs)("div",{className:"text-2xl font-bold text-blue-900",children:[(0,V.uf)(v)," 万元"]}),(0,n.jsxs)("div",{className:"text-sm text-blue-600 mt-1",children:["达成率: ",el(v>0?y/v:null)]})]}),(0,n.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,n.jsx)("div",{className:"text-sm text-green-600 mb-1",children:"调整后目标"}),(0,n.jsxs)("div",{className:"text-2xl font-bold text-green-900",children:[(0,V.uf)(f)," 万元"]}),(0,n.jsxs)("div",{className:"text-sm text-green-600 mt-1",children:["达成率: ",el(f>0?y/f:null)]})]}),(0,n.jsxs)("div",{className:"bg-purple-50 p-4 rounded-lg",children:[(0,n.jsx)("div",{className:"text-sm text-purple-600 mb-1",children:"实际完成"}),(0,n.jsxs)("div",{className:"text-2xl font-bold text-purple-900",children:[(0,V.uf)(y)," 万元"]})]})]})})]}),(0,n.jsxs)(c.Zb,{children:[(0,n.jsx)(c.Ol,{children:(0,n.jsx)(c.ll,{children:"目标详情"})}),(0,n.jsx)(c.aY,{children:(0,n.jsx)(D,{})})]}),(0,n.jsx)(X,{})]})]})})}}},function(e){e.O(0,[878,618,502,49,88,406,744],function(){return e(e.s=56623)}),_N_E=e.O()}]);