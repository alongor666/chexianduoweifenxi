name: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ç´¢å¼•

on:
  pull_request:
    paths:
      - 'å¼€å‘æ–‡æ¡£/**'
      - 'scripts/generate_docs_index.py'
    types: [opened, synchronize]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  update-index:
    name: æ›´æ–°çŸ¥è¯†åº“ç´¢å¼•
    runs-on: ubuntu-latest
    # åªåœ¨éæœºå™¨äººæäº¤çš„PRä¸Šè¿è¡Œï¼Œé¿å…å¾ªç¯
    if: github.event.pull_request.user.type != 'Bot'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å¤‡ä»½å½“å‰ç´¢å¼•
        run: |
          cp å¼€å‘æ–‡æ¡£/KNOWLEDGE_INDEX.md /tmp/KNOWLEDGE_INDEX_BACKUP.md

      - name: é‡æ–°ç”Ÿæˆç´¢å¼•
        run: |
          python3 scripts/generate_docs_index.py å¼€å‘æ–‡æ¡£

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        id: check_changes
        run: |
          # ç§»é™¤æ—¶é—´æˆ³è¡Œè¿›è¡Œæ¯”è¾ƒ
          grep -v "^> ğŸ“… æœ€åæ›´æ–°:" /tmp/KNOWLEDGE_INDEX_BACKUP.md > /tmp/old.md || true
          grep -v "^> ğŸ“… æœ€åæ›´æ–°:" å¼€å‘æ–‡æ¡£/KNOWLEDGE_INDEX.md > /tmp/new.md || true

          if ! diff -q /tmp/old.md /tmp/new.md > /dev/null; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ°ç´¢å¼•éœ€è¦æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… ç´¢å¼•å·²æ˜¯æœ€æ–°" >> $GITHUB_STEP_SUMMARY
          fi

      - name: é…ç½® Git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: æäº¤æ›´æ–°çš„ç´¢å¼•
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add å¼€å‘æ–‡æ¡£/KNOWLEDGE_INDEX.md
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ç´¢å¼•

          ğŸ“– æ–‡æ¡£ç´¢å¼•å·²è‡ªåŠ¨æ›´æ–°ä»¥åæ˜ æœ€æ–°çš„æ–‡æ¡£ç»“æ„ã€‚

          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          git push

      - name: æ·»åŠ è¯„è®º
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“– **æ–‡æ¡£ç´¢å¼•å·²è‡ªåŠ¨æ›´æ–°**\n\nçŸ¥è¯†åº“ç´¢å¼• `KNOWLEDGE_INDEX.md` å·²æ ¹æ®æ–‡æ¡£å˜æ›´è‡ªåŠ¨æ›´æ–°ã€‚'
            })
