# 前后端分离改造计划

> 状态: IN_PROGRESS
> 创建时间: 2026-02-02
> BACKLOG ID: FBS-001

## 一、背景与目标

### 1.1 当前问题

1. **Store 过于庞大** (991 行)
   - `use-app-store.ts` 承载过多职责：数据、筛选、KPI、UI 状态混合

2. **逻辑重复**
   - 数据过滤逻辑存在于多处：useAppStore、useFilteredData、DataService
   - KPI 计算散落在多个地方

3. **组件深度耦合**
   - 71% 的组件直接依赖 useAppStore
   - 没有业务逻辑 Hooks 中间层

4. **服务层与应用层不清晰**
   - `src/services/DataService` 与 `src/application/services/data-service` 重复
   - 职责边界模糊

5. **持久化分散**
   - 3 处不同的实现：lib/storage、services、store

### 1.2 改造目标

- 清晰的前后端职责边界
- 规范化的 API 设计
- 精简的前端状态管理
- 业务逻辑 Hooks 中间层
- 保持功能完整性

## 二、架构设计

### 2.1 目标架构

```
┌─────────────────────────────────────────────────────┐
│                    【前端】                          │
├─────────────────────────────────────────────────────┤
│  展示层 (Components)                                │
│    ↓                                                │
│  业务 Hooks 层 (Business Hooks)                     │
│    ├─ useInsuranceRecords() - 数据查询              │
│    ├─ useKPIData() - KPI 获取                       │
│    ├─ useDataFilters() - 筛选管理                   │
│    └─ useDataUpload() - 数据上传                    │
│    ↓                                                │
│  API 客户端层 (API Client)                          │
│    └─ apiClient.ts - 统一请求封装                   │
│    ↓                                                │
│  状态层 (Store)                                     │
│    └─ 精简后只保留 UI 状态和缓存                    │
├─────────────────────────────────────────────────────┤
│                    【后端】                          │
├─────────────────────────────────────────────────────┤
│  API 路由层 (Next.js Route Handlers)                │
│    ├─ GET  /api/v1/records      - 查询记录          │
│    ├─ POST /api/v1/records      - 创建记录          │
│    ├─ POST /api/v1/kpi/calculate - KPI 计算         │
│    ├─ GET  /api/v1/kpi/trends   - 趋势数据          │
│    ├─ GET  /api/v1/filters/options - 筛选选项       │
│    └─ POST /api/v1/export       - 数据导出          │
│    ↓                                                │
│  应用层 (Application)                               │
│    └─ Use Cases                                     │
│    ↓                                                │
│  领域层 (Domain)                                    │
│    └─ 业务规则 & 实体                               │
│    ↓                                                │
│  基础设施层 (Infrastructure)                         │
│    └─ 数据存储 & 外部适配                           │
└─────────────────────────────────────────────────────┘
```

### 2.2 API 设计规范

| 端点 | 方法 | 描述 | 请求 | 响应 |
|------|------|------|------|------|
| `/api/v1/records` | GET | 查询保险记录 | ?filters=... | `{ data: InsuranceRecord[], total: number }` |
| `/api/v1/records` | POST | 创建/导入记录 | `{ records: RawData[] }` | `{ success: boolean, count: number }` |
| `/api/v1/kpi/calculate` | POST | 计算 KPI | `{ filters: FilterState, options: KPIOptions }` | `{ data: KPIResult }` |
| `/api/v1/kpi/trends` | GET | 获取趋势 | ?weeks=... | `{ data: TrendData[] }` |
| `/api/v1/filters/options` | GET | 获取筛选选项 | ?context=... | `{ options: FilterOptions }` |
| `/api/v1/export` | POST | 导出数据 | `{ format, filters }` | Blob |

## 三、实施阶段

### 阶段 1: 后端 API 规范化 (已完成)

- [x] 创建计划文件
- [x] 创建 API v1 目录结构
- [x] 实现 `/api/v1/records` 端点
- [x] 实现 `/api/v1/kpi/calculate` 端点
- [x] 实现 `/api/v1/kpi/trends` 端点
- [x] 实现 `/api/v1/filters/options` 端点
- [x] 实现 `/api/v1/export` 端点
- [x] 添加 API 错误处理和响应格式化

### 阶段 2: 前端 API 客户端 (已完成)

- [x] 创建 `src/lib/api/client.ts` 统一请求封装
- [x] 创建 `src/lib/api/records.ts` 记录 API
- [x] 创建 `src/lib/api/kpi.ts` KPI API
- [x] 创建 `src/lib/api/filters.ts` 筛选 API
- [x] 创建 `src/lib/api/export.ts` 导出 API
- [x] 创建 `src/lib/api/types.ts` API 类型定义

### 阶段 3: 业务 Hooks 层 (已完成)

- [x] 创建 `src/hooks/api/useInsuranceRecords.ts`
- [x] 创建 `src/hooks/api/useKPIData.ts`
- [x] 创建 `src/hooks/api/useFilterOptions.ts`
- [x] 创建 `src/hooks/api/useDataUpload.ts`

### 阶段 4: Store 精简

- [ ] 从 Store 移除业务逻辑
- [ ] Store 只保留 UI 状态
- [ ] 使用 React Query 或 SWR 管理服务端状态

### 阶段 5: 组件迁移

- [ ] 组件改为使用新的业务 Hooks
- [ ] 移除对 useAppStore 数据部分的直接依赖
- [ ] 验证功能完整性

## 四、文件清单

### 4.1 新增文件

```
src/app/api/v1/
├── records/
│   └── route.ts              # 记录 CRUD
├── kpi/
│   ├── calculate/
│   │   └── route.ts          # KPI 计算
│   └── trends/
│       └── route.ts          # KPI 趋势
├── filters/
│   └── options/
│       └── route.ts          # 筛选选项
└── export/
    └── route.ts              # 数据导出

src/lib/api/
├── client.ts                 # API 客户端
├── records.ts                # 记录 API
├── kpi.ts                    # KPI API
├── filters.ts                # 筛选 API
└── types.ts                  # API 类型定义

src/hooks/api/
├── useInsuranceRecords.ts    # 记录查询 Hook
├── useKPIData.ts             # KPI 数据 Hook
├── useFilterOptions.ts       # 筛选选项 Hook
├── useDataUpload.ts          # 数据上传 Hook
└── index.ts                  # 导出
```

### 4.2 修改文件

- `src/store/use-app-store.ts` - 精简职责
- `src/hooks/use-kpi.ts` - 改为调用 API
- `src/hooks/use-filtered-data.ts` - 改为调用 API

## 五、验收标准

1. 所有 API 端点正常工作
2. 前端功能保持完整
3. 构建无错误
4. 类型检查通过
5. 现有测试通过

## 六、注意事项

1. 保持向后兼容，逐步迁移
2. 静态导出模式时 API 不可用，需要降级处理
3. 保留本地模式支持
4. 遵循项目护栏规则

## 七、进度记录

| 日期 | 进度 | 备注 |
|------|------|------|
| 2026-02-02 | 创建计划 | 分析现有架构，制定改造方案 |
| 2026-02-02 | 阶段1-3完成 | API 端点、客户端、业务 Hooks 层全部完成，类型检查通过 |
