# 变更日志 / Changelog

本文档记录 insurance-weekly-report 技能的所有重要变更。

---

## [v2.1.1] - 2025-12-09

### 🎯 核心改进：KPI 计算对齐

**目标**：完全对齐 kpi-calculator 技能的 KPI 计算公式，确保两个技能的计算结果一致。

### ✨ 新增功能

#### 新增 5 个核心 KPI
1. **满期率** = 满期保费 / 签单保费 × 100%
2. **满期边际贡献率** = 100% - 变动成本率
3. **满期边际贡献额** = 满期保费 × 满期边际贡献率
4. **单均保费** = 签单保费 / 保单件数
5. **单均费用** = 费用金额 / 保单件数

### 🔧 修正

#### 出险率计算修正
- **修改前**：`出险率 = 出险件数 / 保单件数 × 100`
- **修改后**：`满期出险率 = (出险件数 / 保单件数) × 满期率`
- **原因**：考虑保单成熟度因素，避免未满期保单影响

### 🚀 技术改进

#### 增强公式解析器
- 支持括号运算：`(A / B) * C / 100`
- 支持多级运算优先级
- 改进字段名匹配逻辑（按长度降序避免误替换）
- 更详细的错误提示

#### 单元测试
- 新增 `test_kpi_alignment.py`
- 验证 10 个 KPI 计算准确性
- 交叉验证通过（误差 < 0.05%）
- 测试公式解析器对括号的支持

### 📝 更新文件

#### 配置文件
- `references/field_mappings.json`
  - 新增 5 个 KPI 配置
  - 修正出险率公式
  - 更新输出字段列表

#### 代码文件
- `scripts/data_transformer.py`
  - 增强 `_eval_formula()` 函数
  - 支持括号和复杂公式
  - 改进异常处理

- `prepare_week49_data.py`
  - 对齐所有 KPI 计算公式
  - 新增 5 个 KPI 计算
  - 更新输出字段列表

#### 文档文件
- `SKILL.md`
  - 新增"KPI 计算公式"章节
  - 说明与 kpi-calculator 的关系
  - 更新版本信息

- `README.txt`
  - 列出新增 KPI
  - 更新版本号

- `CHANGELOG.md`（新建）
  - 记录 v2.1.1 的所有变更

### 🎯 验证结果

**单元测试结果**：
```
✅ 满期赔付率      - 通过
✅ 费用率          - 通过
✅ 变动成本率      - 通过
✅ 满期率          - 通过（新增）
✅ 满期边际贡献率  - 通过（新增）
✅ 出险率          - 通过（修正）
✅ 案均赔款        - 通过
✅ 单均保费        - 通过（新增）
✅ 单均费用        - 通过（新增）
✅ 满期边际贡献额  - 通过（新增）
```

**测试数据**：
- 签单保费：2,600,000 元
- 满期保费：2,340,000 元
- 保单件数：260
- 出险件数：63

**结论**：所有 KPI 计算与 kpi-calculator 完全一致 ✅

### 📦 影响范围

#### 向后兼容性
- ✅ **完全兼容**：现有数据文件无需修改
- ✅ **输出扩展**：新增字段不影响现有字段
- ✅ **配置兼容**：旧版配置文件继续有效

#### 性能影响
- ✅ **无性能下降**：新增 KPI 计算复杂度为 O(1)
- ✅ **公式解析优化**：按字段名长度排序提高匹配准确性

### 🔗 相关技能

- **kpi-calculator**：KPI 计算基准技能
- **agentcharts-weekly-increment**：周度数据可视化技能

---

## [v2.1.0] - 2025-12-09

### 🎯 核心改进：自动数据转换

**目标**：支持保单明细数据直接上传，无需预处理。

### ✨ 新增功能

#### 自动数据格式识别
- 自动识别中文字段（汇总数据）
- 自动识别英文字段（明细数据）
- 支持自定义字段映射配置

#### 明细数据自动聚合
- 分机构聚合
- 分客户类别聚合
- 分机构+客户类别聚合
- 自动计算率值指标

#### 字段映射配置化
- 新增 `references/field_mappings.json`
- 支持多种预设映射方案
- 用户可自定义映射规则

### 🚀 技术改进

#### 模块化架构
- 新增 `scripts/data_transformer.py`
- 数据处理与报告生成解耦
- 符合 Anthropic Skills 最佳实践

#### 数据验证
- 自动验证必需字段
- 数据类型转换
- 异常值处理

### 📝 新增文件

- `scripts/data_transformer.py`
- `references/field_mappings.json`

---

## [v2.0.0] - 2025-12-08

### 🎯 初始版本

**目标**：生成麦肯锡风格的车险周报 PPT。

### ✨ 核心功能

#### 报告生成
- 12-13 页结构化报告
- 问题导向标题自动生成
- 双维度分析（分机构 + 分客户类别）

#### 数据可视化
- 四象限图
- 气泡图
- 麦肯锡配色方案

#### 配置化管理
- `references/thresholds.json` - 阈值配置
- `references/plans.json` - 保费计划

### 📦 技术栈

- pandas, numpy - 数据处理
- python-pptx - PPT 生成
- matplotlib - 图表绘制

---

## 版本命名规则

- **主版本号（Major）**：重大架构变更或不兼容更新
- **次版本号（Minor）**：新增功能或重要改进
- **修订号（Patch）**：Bug 修复或小幅改进

示例：v2.1.1
- 2 = 主版本（McKinsey 风格报告生成器）
- 1 = 次版本（自动数据转换功能）
- 1 = 修订（KPI 计算对齐）
