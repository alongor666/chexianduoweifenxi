---
name: kpi-calculator
description: 验证和调试车险业务16个核心KPI的计算逻辑，包括满期边际贡献率、满期赔付率、单均保费等。当用户提到"KPI"、"计算"、"赔付率"、"边际贡献"、"指标"时使用。
allowed-tools: Read, Grep, Bash
---

# Instructions

## 核心职责

本技能专注于车险业务 KPI 计算逻辑的验证和调试，确保 16 个核心指标计算正确。

**职责范围**：
- ✅ 验证 KPI 计算逻辑是否符合标准公式
- ✅ 调试 KPI 数值异常（NaN、Infinity、异常大/小）
- ✅ 检查代码实现与文档定义的一致性
- ❌ 不对业务结论做判断（如"该分支机构经营良好"）
- ❌ 不假设字段名或表结构

## 执行流程

### 1. 需求澄清
在开始验证前，必须确认：
- **KPI 名称**：用户要验证哪个具体指标？
- **问题类型**：验证正确性、调试异常、理解业务含义？
- **数据来源**：承保清单、周报快照、DuckDB？

如果用户请求模糊（如"帮我验证 KPI 计算"），必须追问明确。

### 2. 读取标准定义
```bash
Read 开发文档/03_technical_design/core_calculations.md
```
获取该 KPI 的标准公式定义。

### 3. 定位代码实现
使用 Grep 查找相关代码：
```bash
# 查找 KPI 计算引擎
Grep pattern="loss_ratio|边际贡献率" path="src/"
```

### 4. 对比验证
检查点：
- 公式是否与 `core_calculations.md` 一致？
- 是否有除零保护（`safeDivide` 函数）？
- 单位转换是否正确（元 → 万元 → 百分比）？
- NULL 值处理是否合理？

### 5. 输出验证报告
必须包含：
- **公式定义**：来自 `core_calculations.md`
- **代码实现**：具体文件路径和行号
- **验证结果**：✅ 通过 / ❌ 失败 / ⚠️ 警告
- **示例计算**：使用具体数值演示
- **业务解读**：正常范围和风险提示

### 6. 自查清单
输出前必须确认：
- [ ] 公式来源是否明确标注？
- [ ] 代码位置是否精确（文件路径 + 行号）？
- [ ] 示例计算是否完整？
- [ ] 是否提供了业务解读？

## 限制与边界

- **不创造字段**：严格基于 `InsuranceRecord` 26 字段结构
- **不修改代码**：只读取和分析，修复建议需用户执行
- **遇到歧义必须追问**：KPI 名称不明确、问题描述模糊时

## 核心文件位置

- 计算引擎：`src/lib/calculations/kpi-engine.ts`
- 公式定义：`src/lib/calculations/kpi-formulas.ts`
- Hook 层：`src/hooks/domains/useKPICalculation.ts`
- 文档定义：`开发文档/03_technical_design/core_calculations.md`

详细的 KPI 定义和常见问题请参考 `reference.md`。

# Examples

## 示例 1：验证满期赔付率

**用户输入**：
> 帮我验证一下满期赔付率的计算是否正确

**正确处理流程**：
1. 读取 `core_calculations.md` 获取公式：`满期赔付率 = 已报告赔款 / 满期保费 × 100%`
2. 使用 Grep 搜索 `loss_ratio` 找到代码实现
3. 对比验证：
   - ✅ 公式与文档一致
   - ✅ 包含除零保护 (`safeDivide`)
   - ✅ 结果转换为百分比（乘以 100）
4. 输出验证报告

## 示例 2：调试 NaN 异常

**用户输入**：
> 保费时间进度达成率显示 NaN，帮我查一下原因

**正确处理流程**：
1. 确认 KPI：保费时间进度达成率
2. 读取公式定义
3. 检查可能导致 NaN 的原因：
   - 分母为 0（年度目标保费为 0）
   - 数据缺失（`signed_premium_yuan` 为 NULL）
4. 定位代码中的除零保护逻辑
5. 提供修复建议：确认年度目标保费已配置

## 示例 3：用户请求不明确

**用户输入**：
> 帮我验证 KPI 计算

**正确处理流程**：
询问用户：
> 请问您要验证哪个 KPI？以下是 16 个核心 KPI：
> - 满期边际贡献率
> - 保费时间进度达成率
> - 满期赔付率
> - 费用率
> - ...（列出所有 KPI）

# Version History

## v1.0 (2025-11-17)
- 初始版本，支持 16 个核心 KPI 验证
- 实现公式对比、代码检查、异常调试
- 遵循 Anthropic 官方 Skills 最佳实践
