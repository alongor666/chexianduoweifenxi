# 数据处理规则

## 数据性质理解 (关键)

### CSV 数据特征

车险业务数据具有以下特征:

- **时间截止点**: 每周六 (week ending on Saturday)
- **数据性质**: 年初至当周六的累计数据 (YTD cumulative)
- **NOT 单周数据**: CSV 中的数值是累计值，不是单周发生额

### 正确理解示例

```
第1周 (截至1月4日): 签单保费 = 100万元 (年初至今累计)
第2周 (截至1月11日): 签单保费 = 250万元 (年初至今累计)
→ 第2周增量 = 250 - 100 = 150万元 (第2周实际发生)
```

## 计算规则 (必须遵守)

### 比率指标

**必须基于累计数据计算**:

```typescript
// 正确 ✅
满期赔付率 = 累计已报告赔款 / 累计满期保费

// 错误 ❌ (会产生剧烈波动)
满期赔付率 = 周增量赔款 / 周增量保费
```

### 绝对值指标

可用累计或增量，根据展示需求:

```typescript
// 累计视角
签单保费 = CSV中的累计值

// 增量视角
周签单保费 = 本周累计 - 上周累计
```

### 均值指标

根据视角选择:

```typescript
// 累计视角
单均保费 = 累计签单保费 / 累计保单件数

// 增量视角
周单均保费 = 周增量保费 / 周增量件数
```

## 安全计算规则

### 除零保护

```typescript
function safeDivide(a: number, b: number): number | null {
  if (b <= 0) return null;
  return a / b;
}
```

### 单位转换

| 类型 | 转换规则 | 示例 |
|------|----------|------|
| 金额 | 元 → 万元 (÷10000) | 1000000 → 100 万元 |
| 比率 | 小数 → 百分比 (×100) | 0.6215 → 62.15% |
| 均值 | 保留整数元 | 3567.89 → 3568 元 |

## 字段映射

支持中英文字段名自动适配:

| 中文字段 | 英文字段 |
|----------|----------|
| 签单保费 | signed_premium_yuan |
| 满期保费 | matured_premium_yuan |
| 保单件数 | policy_count |
| 赔案件数 | claim_case_count |
| 已报告赔款 | reported_claim_payment_yuan |
| 费用金额 | expense_amount_yuan |

## 周次计算规则

### 50 周工作制

- 周计划 = 年度目标 ÷ 50 (不是 52)
- 第 1 周可能不足 7 天
- 第 N 周结束日 = 第 1 周结束日 + (N-1) × 7 天

### 时间进度

```typescript
年度时间进度 = 已过天数 / 365
保费时间进度达成率 = (累计保费/年度目标) / 年度时间进度 × 100%
```

## 数据验证规则

### 必检项

1. **必需字段存在**: 签单保费、保单件数等核心字段
2. **数据类型正确**: 数值字段为数字，日期字段为日期
3. **数值范围合理**: 无负数保费，比率在 0-200% 内

### 警告项

- 单周增量为负数 (可能是数据更正)
- 比率异常 (>100% 的综合成本率)
- 周次不连续

## 参考实现

- `src/domain/rules/kpi-calculator.ts` - 纯函数计算
- `src/lib/calculations/kpi-engine.ts` - 计算引擎
- `src/lib/calculations/kpi-formulas.ts` - 公式定义
