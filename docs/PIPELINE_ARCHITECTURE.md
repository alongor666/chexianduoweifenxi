# 流水线架构说明

本文描述 AgentDB/Claude Skills 的流水线结构与数据流，方便你在集成时进行性能优化与扩展。

## 五阶段创建流程
1. **输入解析**：接收用户请求、系统指令与上下文，并进行字段校验。
2. **检索与记忆**：调用向量检索、关键字检索与时间过滤，合并结果。
3. **技能规划**：根据意图选择技能或技能套件，生成执行计划。
4. **执行与补偿**：按计划调用外部 API 或内部逻辑，失败时触发重试与补偿策略。
5. **响应生成**：将检索结果、技能输出与推理过程结合，生成最终答复并写回记忆。

## 数据流与转换
- 输入在解析阶段转为标准化请求对象。
- 检索阶段生成候选记忆列表，附带相似度、时间戳与来源。
- 技能规划阶段输出执行图（节点/边），供执行器消费。
- 执行阶段产生中间结果流水，统一记录 trace_id。
- 响应生成阶段进行格式化与安全审查，最终返回给调用方。

## 集成点
- **检索层**：可替换为自研向量库或混合检索方案。
- **技能层**：支持在 `skills/` 目录新增技能定义或套件配置。
- **观测层**：接入现有的 APM/Tracing 平台，上传指标与日志。

## 性能优化
- 对高频技能启用结果缓存或并发控制，避免外部 API 过载。
- 在检索阶段限制候选数量，并使用多路召回 + 轻量 rerank。
- 对长对话使用摘要写回，降低上下文长度与费用。

## 常见扩展
- 增加新渠道接入时，只需在输入解析阶段添加适配器并复用后续阶段。
- 若需要审计，开启全链路日志并存档到对象存储，配合 trace_id 检索。
