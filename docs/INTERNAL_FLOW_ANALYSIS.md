# 内部流程分析

本文件拆解 AgentDB 的内部流程与关键决策点，帮助你理解每一步的逻辑与恢复策略。

## 分阶段拆解

1. **入口校验**：校验 API 密钥、请求体大小与字段合法性，失败直接返回 4xx。
2. **意图识别**：分类请求类型（检索、技能、因果等），决定后续子流程。
3. **检索合并**：向量召回、关键词召回、时间过滤后合并去重，并记录评分。
4. **技能选路**：依据意图与上下文选择技能，若多技能可行则进行优先级排序。
5. **执行监控**：执行器对每一步生成 trace 事件，包含输入、输出、耗时与错误。
6. **结果生成**：聚合检索结果与技能输出，执行安全检查后返回。
7. **记忆写回**：将新产生的事实、原因或结论写入 AgentDB，以便后续引用。

## 决策逻辑

- 当检索命中数不足时，自动回退到扩展召回或提示用户补充信息。
- 当技能执行失败且可重试时，启用指数退避重试；不可重试则降级为提示说明。
- 当回答存在敏感字段时，触发脱敏或拒答策略。

## 错误处理与恢复

- **输入错误**：返回详细提示并附带正确示例。
- **外部 API 失败**：记录错误码，重试后仍失败则写入告警渠道。
- **超时**：在执行器层面设置超时并终止，返回部分可用结果与说明。

## 质量保证

- 为关键路径编写单元测试与集成测试，覆盖检索、技能与因果链路。
- 定期回放生产日志，验证召回质量与回答一致性。
- 使用观测指标（命中率、P95 延迟、错误率）监控健康度。
