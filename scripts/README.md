# Python 数据处理脚本

## CSV 转 DuckDB 转换工具

### 快速开始

#### 1. 安装依赖

```bash
# 使用 pip 安装
pip install -r scripts/requirements.txt

# 或者单独安装 DuckDB
pip install duckdb
```

#### 2. 准备 CSV 文件

确保您的 CSV 文件放在 `实际数据/` 目录下：

```
实际数据/
├── 2025保单第42周变动成本明细表.csv
├── 2025保单第43周变动成本明细表.csv
├── 2025保单第44周变动成本明细表.csv
└── 2025保单第45周变动成本明细表.csv
```

#### 3. 运行转换脚本

```bash
python3 scripts/etl_to_duckdb.py
```

#### 4. 使用生成的数据库

脚本会生成 `insurance_data.duckdb` 文件，您可以在网页中上传这个文件进行分析。

### 输出示例

```
================================================================================
🚀 CSV 转 DuckDB 转换工具
================================================================================
📁 找到 4 个 CSV 文件:
   1. 2025保单第42周变动成本明细表.csv (3.60 MB)
   2. 2025保单第43周变动成本明细表.csv (3.70 MB)
   3. 2025保单第44周变动成本明细表.csv (3.70 MB)
   4. 2025保单第45周变动成本明细表.csv (3.80 MB)

🔨 创建数据库: insurance_data.duckdb
✅ 数据库连接已建立

📥 开始导入 CSV 文件...
   [1/4] 处理: 2025保单第42周变动成本明细表.csv
      ✅ 表已创建
      ⏱️  耗时: 0.85秒

   ... (省略其他文件)

✅ 所有文件导入完成，总耗时: 3.42秒

🧹 数据清洗...
   ✅ 数据完整，无需清理

⚡ 创建索引...
   ✅ idx_week: week_number
   ✅ idx_year: policy_start_year
   ✅ idx_org: third_level_organization
   ... (省略其他索引)

🗜️  优化数据库...
   ✅ 数据库已优化

📊 数据统计:
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   总记录数:     61,234 条
   周次范围:     第 42 周 ~ 第 45 周 (共 4 周)
   三级机构:     13 个
   业务类型:     16 种
   签单保费:     12,345.67 万元
   保单件数:     61,234 件
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💾 数据库文件:
   路径: /Users/xxx/insurance_data.duckdb
   大小: 2.85 MB
   压缩比: 81.2% (原始CSV: 15.20 MB)

================================================================================
🎉 转换成功完成！
================================================================================

下一步: 在网页中选择 insurance_data.duckdb 文件进行分析
```

### 优势

1. **性能提升**: 查询速度比 CSV 快 10-100 倍
2. **文件压缩**: 数据库文件大小约为原始 CSV 的 20%
3. **索引优化**: 自动创建关键字段索引
4. **数据验证**: 自动清洗无效数据
5. **易于维护**: 增量更新只需重新运行脚本

### 高级用法

#### 自定义输入输出路径

```python
from etl_to_duckdb import ETLConverter

converter = ETLConverter(
    input_dir="path/to/your/data",
    output_db="custom_output.duckdb",
    table_name="insurance_records"
)
converter.run()
```

#### 指定数据目录

```bash
# 指定包含 Excel/CSV 文件的目录
python3 scripts/etl_to_duckdb.py --input-dir "其他数据目录/"
```

### 故障排除

#### 问题: 找不到 CSV 文件

确保文件路径正确，默认查找 `实际数据/*.csv`

#### 问题: 内存不足

DuckDB 会自动管理内存，但如果数据量特别大（百万级），考虑分批处理。

#### 问题: 编码错误

确保 CSV 文件使用 UTF-8 编码。

### 性能对比

| 操作       | CSV 直接解析 | DuckDB   |
| ---------- | ------------ | -------- |
| 加载 6万行 | 2-5 秒       | < 0.5 秒 |
| 筛选查询   | 300-800ms    | 10-30ms  |
| 聚合计算   | 500-1500ms   | 20-50ms  |

### 下一步

转换完成后，在网页中:

1. 点击"上传数据"按钮
2. 选择生成的 `.duckdb` 文件
3. 享受极速数据分析体验！
