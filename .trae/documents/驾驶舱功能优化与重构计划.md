# 驾驶舱功能优化与重构计划

## 现状分析

### 1. 时间筛选功能
- **现状**: 已支持多选模式，通过 `CompactTimeFilter` 组件实现
- **文件位置**: `src/components/filters/compact-time-filter.tsx`
- **功能**: 支持年度多选、周序号多选，单选/多选模式切换
- **结论**: ✅ 已满足需求，无需修改

### 2. 排序功能现状
- **现状**: 部分组件已实现排序，但不统一
- **已实现**: `DimensionBarChart` 组件支持按指标值降序排列（从最好到最差）
- **文件位置**: `src/components/features/dimension-bar-chart.tsx:95-99`
- **问题**: 
  - 排序方向与需求相反（当前从好到差，需要从差到好）
  - 其他图表组件缺少排序功能
- **结论**: ⚠️ 需要统一修改排序逻辑和扩展到所有组件

### 3. 阈值设定现状
- **现状**: 部分组件有硬编码阈值，不统一
- **已实现**: `ExpenseHeatmap` 有4级阈值（excellent/good/warning/danger）
- **文件位置**: `src/components/features/expense-heatmap.tsx:42-50`
- **问题**: 
  - 阈值硬编码在组件中
  - 不同组件阈值标准不一致
  - 缺少"卓越"级别，只有4级而非5级
- **结论**: ⚠️ 需要建立统一的5级阈值体系

### 4. 驾驶舱布局现状
- **现状**: 当前的 `cockpit-section.tsx` 是简单的4x2 KPI网格
- **文件位置**: `src/components/features/modern-dashboard/cockpit-section.tsx`
- **问题**: 
  - 不是用户要求的8个核心KPI布局
  - 缺少第二行的4个统计指标
  - 缺少后续的经营观察模块
- **结论**: ❌ 需要完全重构

## 实施计划

### 阶段一：建立统一阈值体系
1. **创建阈值配置文件** `src/config/thresholds.ts`
   - 定义5级阈值：卓越、优秀、健康、预警、危险
   - 为所有KPI指标设定阈值标准
   - 提供颜色映射和等级判断函数

2. **更新现有组件**
   - 修改 `ExpenseHeatmap` 使用新的阈值体系
   - 统一所有组件的阈值逻辑

### 阶段二：统一排序功能
1. **创建排序工具函数** `src/utils/sorting.ts`
   - 提供统一的排序逻辑（从最差到最好）
   - 支持不同数据类型的排序

2. **更新所有图表组件**
   - `DimensionBarChart`: 修改排序方向
   - `BusinessTypeHeatmap`: 添加排序功能
   - `MultiChartTabs` 中的各个图表: 统一添加排序

### 阶段三：重构驾驶舱布局
1. **创建新的驾驶舱组件** `src/components/features/enterprise-cockpit.tsx`
   - 第一行：4个核心KPI（时间进度达成率、变动成本率、满期赔付率、费用率）
   - 第二行：4个统计指标（落后机构数量、超阈值机构数量等）
   - 第三行及以后：经营观察模块

2. **创建经营观察子组件**
   - `TimeProgressAnalysis`: 时间进度分析
   - `CostRiskAnalysis`: 成本风险分析  
   - `BusinessHealthHeatmap`: 业务健康度热力图
   - `MultiDimensionRadar`: 多维健康度雷达
   - `DynamicBarChart`: 动态条形图
   - `ProportionChart`: 占比分析图

### 阶段四：优化图表展示
1. **实施布局规则**
   - 一行只放一个图（除非需要对比）
   - 移除推荐行动和建议内容
   - 统一状态与颜色匹配

2. **优化交互体验**
   - 确保所有图表支持时间筛选多选
   - 添加维度选择器（机构、业务类型等）
   - 实现点击下钻功能

### 阶段五：集成与测试
1. **更新主页面** `src/app/page.tsx`
2. **运行完整测试**: `pnpm lint && pnpm tsc --noEmit && pnpm build`
3. **验证所有功能正常工作**

## 技术要点

### 新增文件清单
- `src/config/thresholds.ts` - 统一阈值配置
- `src/utils/sorting.ts` - 排序工具函数
- `src/components/features/enterprise-cockpit.tsx` - 新驾驶舱主组件
- `src/components/features/cockpit/kpi-metrics-row.tsx` - KPI指标行
- `src/components/features/cockpit/statistics-row.tsx` - 统计指标行
- `src/components/features/cockpit/business-observation/` - 经营观察模块目录

### 修改文件清单
- `src/components/features/expense-heatmap.tsx` - 使用新阈值体系
- `src/components/features/dimension-bar-chart.tsx` - 修改排序方向
- `src/components/features/multi-chart-tabs.tsx` - 统一排序和阈值
- `src/app/page.tsx` - 集成新驾驶舱

### 预期效果
- 统一的5级阈值体系（卓越、优秀、健康、预警、危险）
- 所有图表支持从最差到最好的排序
- 符合用户要求的8+4驾驶舱布局
- 完整的经营观察分析功能
- 一致的视觉体验和交互逻辑