# 保费时间进度达成率修复报告

**修复日期**: 2025-12-22
**问题标签**: #保费时间进度达成率 #年度计划 #KPI计算

---

## 🔍 问题诊断

### 核心问题
CSV中的 `premium_plan_yuan` 字段（明细级计划值）与 `src/data/reference/year-plans.json` 的年度总计划被混用，导致保费时间进度达成率计算错误。

### 数据流问题分析

**期望流程**：
```
CSV上传 → 数据规范化 → UI筛选器 → useKPI hook → year-plans.json年度计划 → KPI计算 → 正确显示
```

**实际流程（修复前）**：
```
CSV上传 → 数据规范化 → UI筛选器 → useKPI hook → ❌ 混用CSV计划和JSON计划 → ❌ 错误计算 → ❌ 错误显示
```

### 具体问题点

1. **数据语义不一致**
   - CSV中的 `premium_plan_yuan`：每条记录的计划值（聚合后为累计计划）
   - `year-plans.json` 中的计划：年度总计划值
   - 这两个值**不应该混用**！

2. **use-kpi.ts 的年度计划匹配逻辑不完善**
   - 从 `YearPlanRepository` 加载数据
   - 但匹配逻辑可能失败时缺乏清晰的降级策略

3. **kpi-calculator-enhanced.ts 的错误降级**
   当 `annualTargetYuan` 为 null 时，会降级使用 CSV 聚合的计划值，导致计算错误！

---

## ✅ 修复方案

### 决策
**永远使用 `src/data/reference/year-plans.json` 的年度计划总值，忽略CSV中的 `premium_plan_yuan` 字段。**

### 修复内容

#### 1. 修改 use-kpi.ts

**关键修改**：
- 添加注释说明永远从 `year-plans.json` 读取年度计划
- 改进机构名称规范化匹配逻辑
- 在依赖数组中添加 `years` 和 `yearPlansData`

#### 2. 修改 kpi-calculator-enhanced.ts

**关键修改**：
- 移除了错误的降级逻辑 `?? aggregated.premium_plan_yuan`
- 聚合函数中不再累加 CSV 的 `premium_plan_yuan`
- 添加注释说明年度计划值永远从 year-plans.json 中读取

#### 3. 修复 load-year-plans.ts

**问题**：该文件引用了旧的 `src/config/year-plans.json`（已不存在）

**修复**：
- 更新导入路径为 `@/data/reference/year-plans.json`
- 适配新的 JSON 格式 `{ "year_plans_2025": [...] }`
- 添加注释说明该文件已被 `YearPlanRepository` 替代

---

## 🎯 验证结果

### 1. TypeScript 类型检查
✅ **通过**：无类型错误

### 2. 构建检查
✅ **通过**：构建成功

### 3. 数据流验证

**修复后的正确流程**：
```
CSV上传（带premium_plan_yuan，但被忽略）
    ↓
数据规范化（premiumPlanYuan字段保留但设为null）
    ↓
UI筛选器（选择机构）
    ↓
useKPI hook（从year-plans.json加载对应机构的年度计划）
    ↓
KPI计算器（使用传入的annualTargetYuan，不使用聚合的计划值）
    ↓
保费时间进度达成率 = (累计保费 / 年度计划) / 时间进度 × 100%
    ↓
✅ UI正确显示
```

---

## 📊 影响范围

### 直接影响的文件
1. src/hooks/use-kpi.ts - KPI计算入口
2. src/domain/rules/kpi-calculator-enhanced.ts - KPI计算核心逻辑
3. src/config/load-year-plans.ts - 年度计划加载（向后兼容）

### 数据依赖
- **必需**：src/data/reference/year-plans.json 必须包含所有机构的年度计划
- **忽略**：CSV中的 `premium_plan_yuan` 字段不再参与KPI计算

---

## 🚀 后续建议

### 1. 数据质量保证
- 确保 `year-plans.json` 中所有机构的计划值准确无误
- 定期更新年度计划数据（每年初）

### 2. 用户指导
- 告知用户CSV中的 `premium_plan_yuan` 字段不再影响KPI计算
- 如需修改年度计划，应编辑 `year-plans.json`

### 3. 代码清理（可选）
- 考虑完全移除 CSV 导入中的 `premium_plan_yuan` 字段验证
- 或将该字段用于其他用途（如记录级计划分析）

---

## ✅ 修复确认清单

- [x] 修复 use-kpi.ts 的年度计划加载逻辑
- [x] 修复 kpi-calculator-enhanced.ts 的计划值使用
- [x] 修复 load-year-plans.ts 的JSON路径
- [x] 通过 TypeScript 类型检查
- [x] 通过构建检查
- [x] 创建修复报告文档
- [ ] 本地测试验证（需用户确认）
- [ ] 更新相关开发文档

---

**修复完成！请在浏览器中测试保费时间进度达成率指标是否正确显示。**
