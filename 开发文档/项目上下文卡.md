# 项目上下文卡（Project Context Card）

## 1. 一句话定义
- 本项目是：面向车险经营团队的“静态优先 / 本地优先”多维分析网页应用，聚焦本地CSV/DuckDB数据的导入、持久化与KPI可视化（来源：开发文档/README.md#项目概览）。

## 2. 目标（Goals）
- G1：提供稳定的车险经营核心指标看板与周度趋势可视化，支撑运营决策（来源：开发文档/01_features/F002_kpi_dashboard/README.md）。
- G2：保障本地优先的数据导入、验证、持久化与回溯能力，并可选接入 Supabase 同步层（来源：开发文档/01_features/F001_data_import/README.md）。
- G3：支持按业务维度（机构、险种、渠道、客户/业务类型等）进行筛选、下钻与对比分析（来源：开发文档/01_features/F004_filters/README.md）。

## 3. 非目标（Non-Goals）
- NG1：不构建服务端数据库或复杂后台管理系统，当前以浏览器本地存储为主，可选 Supabase 仅作同步源。
- NG2：不提供实时流式数据处理或复杂机器学习预测，现阶段聚焦批量导入与可视化分析。

## 4. 用户与关键使用场景（User Journeys）
- 场景A：运营人员 → 上传周度 CSV/ DuckDB 文件 → 通过字段校验与本地持久化 → 打开 KPI 看板查看核心指标与趋势。
- 场景B：分析人员 → 选择机构/险种/渠道等筛选项 → 查看周度趋势与多图联动 → 导出图表或数据用于汇报。
- 场景C：目标管理角色 → 配置年度/维度目标 → 结合看板指标进行达成度评估与调整。

## 5. 关键口径与术语（Source of Truth）
- 数据粒度：以周度-保单条目为最小粒度，含周序号（week_number）和快照日（snapshot_date）（来源：开发文档/03_technical_design/data_architecture.md）。
- 周期口径：按自然周/快照日导入（28-41周样例），周度趋势图以周序号为基准（来源：开发文档/03_technical_design/core_calculations.md）。
- 指标与阈值：核心指标遵循《开发文档/03_technical_design/core_calculations.md》与 `src/domain/rules/kpi-calculator-enhanced.ts`，常用指标含签单/满期保费、赔付率、费用率、边际贡献等，金额字段除个别可为负外需≥0（来源同上）。
- 字段命名约束：CSV/数据层统一使用 `snake_case`（27字段标准），Domain/Hook 层使用 `camelCase`；严禁新增未定义字段（来源：开发文档/03_technical_design/data_architecture.md）。
- 任何口径争议：以《开发文档/03_technical_design/data_architecture.md》与《开发文档/03_technical_design/core_calculations.md》为准。

## 6. 系统边界与合规约束（Boundaries）
- 数据来源：本地上传 CSV（必）、DuckDB 数据库文件（可选）；Supabase 为可选远程同步数据源。
- 输出形态：Next.js 前端静态导出网页（out/），含看板、趋势图、筛选器与导出能力。
- 严禁：泄露密钥、绕过字段/枚举校验、在 Hook/组件中直接编写业务计算公式（必须调用 Domain 层）。

## 7. 技术栈（Stack）
- 前端：Next.js 14（App Router）+ React 18 + TypeScript。
- UI/交互：shadcn/ui、Tailwind CSS。
- 数据处理：Zod 校验、DuckDB-WASM（本地 SQL/列式查询）、Papa Parse。
- 状态管理：Zustand。
- 可视化：ECharts + echarts-for-react。
- 可选远程：Supabase（`@supabase/supabase-js`）。
- CI/CD：GitHub Actions（构建静态导出，校验 README 命令与文档索引）。

## 8. 仓库地图（Repo Map）
- 关键入口：`src/app/page.tsx`（页面根），`src/components/dashboard-client.tsx`（主界面组合）（来源：开发文档/README.md#规范入口索引）。
- 核心模块：`src/hooks/use-kpi.ts`、`src/domain/rules/kpi-calculator-enhanced.ts`、`src/lib/validations/insurance-schema.ts`、`src/lib/storage/data-persistence.ts`、`src/infrastructure/adapters/DuckDBRepository.ts`（来源：开发文档/03_technical_design/data_architecture.md 与 core_calculations.md）。
- 文档入口：`开发文档/KNOWLEDGE_INDEX.md`（索引）、`开发文档/README.md`（概览）。
- 数据样例：`data/` 目录（如样例 CSV/ DuckDB 文件）（来源：开发文档/README.md#项目概览）。

## 9. 本地开发与验证（Commands）
- 安装：`pnpm install`，并复制 `.env.example` 为 `.env.local`。
- 开发启动：`pnpm dev`。
- 构建：`pnpm build`（静态导出到 `out/`）。
- 部署预览：`pnpm deploy:preview`（静态预览 `out/`）。
- 测试：`pnpm test:unit`（Vitest），`pnpm test:e2e`（Playwright）。
- 代码检查：`pnpm validate`（lint + tsc --noEmit + build）。
- 文档索引：`pnpm docs:index`（更新知识库索引）。

## 10. 工程约束（Engineering Rules）
- 目录结构：遵循现有分层，不随意移动核心目录；前端组件/Hook/Domain 分层清晰，KPI 计算仅在 Domain 层实现。
- 代码风格：TypeScript/React；注释与对外文档保持中文；字段命名遵循 camelCase（业务层）与 snake_case（数据层）映射规范。
- 提交与PR：变更需同步相关文档（开发文档/），遵循“阅读架构→修改→验证→更新文档”流程。
- 禁止事项：为规避 lint 而随意改名、在 Hook/组件中编写公式、引入未审批依赖或泄露密钥。

- **复核时间**：2025-02-02 依据最新 `开发文档/README.md` 重新核验 T1-T3 状态。
- 功能进展：P0-P2 核心功能均处于“部分完成”，平均完整度约 73%，P0 模块已实现但需补强（来源：开发文档/README.md 第55-88行）。
- 技术债务：P0 技术债务项“批量上传并行、公式提示、筛选级联”仍未完成，均列在高优先级待办（来源：开发文档/README.md 第169-175行）。
- 决策缺口：ADR-003~006（数据验证、图表库、UI 组件、持久化策略）仍缺失文档（来源：开发文档/README.md 第103-112行）。
- 性能与测试：大数据渲染与交互性能专项测试及覆盖率提升仍为计划项，未见完成记录（来源：开发文档/README.md 第192-199行）。

## 12. 下一步（Next 3 Tasks）
- T1：完成 P0 技术债务（批量上传并行、公式提示、筛选级联），当前状态：未完成（来源：开发文档/README.md 第169-175行）。
- T2：补充缺失 ADR 文档（数据验证、图表库、UI 组件、持久化策略），当前状态：未完成（来源：开发文档/README.md 第103-112行）。
- T3：针对大数据集的渲染与交互性能进行专项测试与优化，并完善相关测试覆盖率，当前状态：未完成（来源：开发文档/README.md 第192-199行）。
