---
id: 02_decisions_adr_009_year_plans_integration
title: 'ADR-009: 年度计划集成方案'
author: AI_Assistant
status: accepted
type: decision
domain: technical
tags:
  - adr
  - configuration
  - targets
created_at: '2025-12-16'
updated_at: '2025-12-16'
---

# ADR-009: 年度计划集成方案

## 状态

✅ **已接受** (Accepted) - 2025-12-16

## 背景

系统需要将年度保费计划 (`year-plans.json`) 集成到目标管理系统中,用于:

1. **时间进度达成率计算**: 需要年度目标作为基准
2. **初始化默认目标**: 新年度开始时快速设置各机构目标
3. **目标一致性**: 确保系统目标与公司下发的年度计划保持一致

### 现状分析

**当前系统目标管理机制**:
- 存储位置: `LocalStorage` (key: `insurDashPremiumTargets`)
- 数据结构: `PremiumTargets` 接口 (定义在 `src/types/insurance.ts`)
- 管理工具: `src/store/utils/target-utils.ts` 提供的工具函数
- 优先级体系: 业务类型 → 三级机构 → 客户类别 → 险种 → 全公司

**year-plans.json 原始格式**:
```json
{
  "年度保费计划": {
    "四川分公司": 431000000,
    "天府": 197300000,
    "武侯": 13500000,
    ...
  }
}
```

## 决策

### 1. 文件位置

**迁移路径**: `开发文档/year-plans.json` → `src/config/year-plans.json`

**理由**:
- ✅ 作为配置文件,应放在 `src/config/` 目录
- ✅ TypeScript 已启用 `resolveJsonModule`,可直接导入
- ✅ 便于版本控制和代码引用

### 2. 集成架构

**创建的文件结构**:

```
src/
├── config/
│   ├── year-plans.json          # 年度计划原始数据
│   └── load-year-plans.ts       # 加载和转换工具
└── utils/
    └── import-year-plans.ts     # 浏览器控制台导入工具
```

**核心函数**:

#### a) `loadYearPlans()` - 数据转换函数
- **位置**: `src/config/load-year-plans.ts`
- **功能**: 将 year-plans.json 转换为 `PremiumTargets` 格式
- **转换逻辑**:
  1. 读取原始JSON数据
  2. 计算全公司总目标(所有机构目标之和)
  3. 将机构目标填充到 `dimensions.thirdLevelOrganization`
  4. 设置时间戳和年份信息

#### b) `importYearPlansToTargets()` - 导入函数
- **位置**: `src/utils/import-year-plans.ts`
- **功能**: 在浏览器控制台中执行,将年度计划导入到系统
- **流程**:
  1. 调用 `loadYearPlans()` 获取转换后的数据
  2. 调用 `processAndSavePremiumTargets()` 保存到 LocalStorage
  3. 输出导入结果日志

### 3. 使用方式

#### 方式一: 浏览器控制台导入 (推荐)

```javascript
// 在浏览器开发者工具控制台中执行:

// 1. 导入年度计划
import('/utils/import-year-plans').then(m => m.importYearPlans())

// 2. 查看当前目标
import('/utils/import-year-plans').then(m => m.viewTargets())

// 3. 清除目标数据
import('/utils/import-year-plans').then(m => m.clearTargets())
```

**或者使用全局快捷方式**:
```javascript
importYearPlans()  // 导入
viewTargets()      // 查看
clearTargets()     // 清除
```

#### 方式二: 代码中使用

```typescript
import { loadYearPlans } from '@/config/load-year-plans'
import { processAndSavePremiumTargets } from '@/store/utils/target-utils'

// 加载2025年度计划
const targets = loadYearPlans(2025)

// 保存到系统
processAndSavePremiumTargets(targets)
```

### 4. 数据映射规则

| year-plans.json | PremiumTargets 结构 | 说明 |
|----------------|-------------------|------|
| 所有机构目标之和 | `overall` | 全公司总目标 |
| 各机构目标 | `dimensions.thirdLevelOrganization.entries` | 三级机构维度目标 |
| - | `byBusinessType` | 业务类型目标(需手动设置) |
| - | `dimensions.businessType` | 业务类型维度目标(需手动设置) |

### 5. 时间进度达成率计算

**集成后的计算流程**:

1. **目标解析** (在 `use-kpi.ts:48-113`):
   ```typescript
   // 优先级: 业务类型 > 三级机构 > 客户类别 > 险种 > 全公司
   const currentTargetYuan = useMemo(() => {
     if (businessTypes.length > 0) {
       // 从 byBusinessType 获取
     }
     if (organizations.length > 0) {
       // 从 dimensions.thirdLevelOrganization 获取
       // 这里使用 year-plans.json 导入的数据
     }
     return premiumTargets.overall  // 最后使用全公司目标
   }, [businessTypes, organizations, premiumTargets])
   ```

2. **时间进度计算** (在 `kpi-calculator-enhanced.ts:346-364`):
   ```typescript
   // 累计模式
   const yearProgress = currentWeekNumber / WORKING_WEEKS_PER_YEAR
   const completionRatio = actualPremium / annualTarget
   const timeProgressRate = (completionRatio / yearProgress) * 100

   // 增量模式
   const weekPlan = annualTarget / WORKING_WEEKS_PER_YEAR
   const timeProgressRate = (weekPremium / weekPlan) * 100
   ```

## 影响

### 正面影响

1. ✅ **统一数据源**: 系统目标与公司年度计划保持一致
2. ✅ **快速初始化**: 新年度开始时一键导入所有机构目标
3. ✅ **版本控制**: year-plans.json 纳入Git管理,便于追踪变更
4. ✅ **灵活调整**: 支持手动微调目标后仍可查看原始计划

### 限制

1. ⚠️ **手动导入**: 需要在浏览器控制台手动执行导入函数
2. ⚠️ **业务类型目标**: year-plans.json 不包含业务类型维度,需单独设置
3. ⚠️ **客户端存储**: 数据存储在 LocalStorage,换设备需重新导入

## 替代方案

### 方案A: 服务端API导入 ❌ 未采用
**优点**: 自动化程度高,支持定时同步
**缺点**:
- 需要后端开发和部署
- 与当前静态部署模式不兼容
- 增加系统复杂度

### 方案B: 直接使用 year-plans.json 作为唯一目标源 ❌ 未采用
**优点**: 简单直接
**缺点**:
- 失去目标微调灵活性
- 无法支持多维度目标(业务类型、客户类别等)
- 不符合现有的多维度目标管理体系

### 方案C: 文件上传导入 ⚠️ 可后续实现
**优点**: UI友好,无需控制台操作
**缺点**:
- 需要开发专门的导入页面
- 增加代码量
- 当前需求不强烈(年度计划变更频率低)

## 相关文档

- [核心指标计算引擎](../03_technical_design/core_calculations.md) - 时间进度达成率计算公式
- [数据架构](../03_technical_design/data_architecture.md) - PremiumTargets 数据结构定义
- [企业驾驶舱](../01_features/F016_enterprise_cockpit/README.md) - 时间进度指标在驾驶舱中的展示

## 实施记录

**日期**: 2025-12-16
**实施内容**:
1. ✅ 迁移 `year-plans.json` 到 `src/config/`
2. ✅ 创建 `load-year-plans.ts` 转换工具
3. ✅ 创建 `import-year-plans.ts` 导入工具
4. ✅ 编写使用文档和示例
5. ✅ 通过验证 (lint + tsc + build)

**验证结果**:
```bash
✅ pnpm lint   - 通过 (仅有无关警告)
✅ pnpm tsc    - 通过
✅ pnpm build  - 通过
✅ pnpm dev    - 启动成功
```

## 使用示例

### 示例1: 年初导入年度计划

```javascript
// 在浏览器控制台执行
import('/utils/import-year-plans').then(m => {
  m.importYearPlans(2025)
})

// 输出:
// ✅ 年度计划已成功导入到系统目标
// 📊 导入数据概览:
//   年份: 2025
//   全公司总目标: 43100.00万元
//   机构数量: 14
//   机构明细: {...}
// 💡 请刷新页面以查看更新后的目标
```

### 示例2: 查看当前系统目标

```javascript
import('/utils/import-year-plans').then(m => {
  m.viewTargets()
})

// 输出:
// 📊 当前系统目标:
//   年份: 2025
//   全公司总目标: 43100.00万元
//   更新时间: "2025-12-16T08:30:00.000Z"
//   三级机构目标: { 四川分公司: 431000000, 天府: 197300000, ... }
//   业务类型目标: {}
```

## 后续优化实施 (2025-12-16 Update)

### ✅ 已实施优化

1. **✅ UI导入界面**: 在数据管理面板添加"年度目标"标签页
   - 组件: `src/components/features/year-plan-import-panel.tsx`
   - 集成: 在 `DataManagementPanel` 中作为独立标签页
   - 特性: 可视化导入界面,无需控制台操作

2. **✅ 差异对比**: 导入前显示新旧目标差异
   - 实现: 自动计算新旧目标的差异
   - 展示: 按变化金额排序,高亮增减变化
   - 格式: 显示变化金额和变化百分比

3. **✅ 导入历史**: 记录每次导入的时间和数据快照
   - 存储: LocalStorage (key: `insurDash_yearPlanImportHistory`)
   - 容量: 保留最近10次导入记录
   - 信息: 导入时间、年份、总目标、机构数量

4. **✅ 数据验证**: 导入时校验机构名称是否与系统数据匹配
   - 验证: 与 `rawData` 中的 `third_level_organization` 字段匹配
   - 警告: 不匹配机构会显示红色警告提示
   - 建议: 提供修复建议(检查拼写或先导入数据)

### 未实施建议

5. **批量调整**: 支持按比例批量调整所有机构目标
   - 理由: 当前需求不强烈,可后续根据实际使用情况添加

### 实施验证结果

```bash
✅ pnpm lint   - 通过
✅ pnpm tsc    - 通过
✅ pnpm build  - 通过
```

**新增文件**:
- `src/components/features/year-plan-import-panel.tsx` (343行)

**修改文件**:
- `src/components/features/data-management-panel.tsx` (添加年度目标标签页)
