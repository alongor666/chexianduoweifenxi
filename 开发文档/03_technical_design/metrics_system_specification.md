---
id: 03_technical_design_metrics_system
title: 车险数据分析平台 - 指标体系全景规范
author: AI
status: stable
type: technical_design
domain: finance
tags:
  - metrics
  - kpi
  - indicator
  - data-flow
  - calculation
  - visualization
created_at: 2025-12-22
updated_at: 2025-12-22
complexity: high
related_code:
  - src/domain/rules/kpi-calculator-enhanced.ts
  - src/services/KPIService.ts
  - src/services/DataService.ts
  - src/hooks/use-kpi.ts
  - src/components/features/cockpit/
  - src/config/thresholds.ts
---

# 车险数据分析平台 - 指标体系全景规范

> **版本**: v1.0
> **状态**: 稳定
> **复杂度**: 高
> **文档目标**: 全面梳理平台所有计算指标、数据流程及呈现规则,建立完整可追溯的指标管理体系

## 目录

1. [指标体系总览](#1-指标体系总览)
2. [基础原始指标](#2-基础原始指标)
3. [核心展示指标 - 4×4网格](#3-核心展示指标---44网格)
4. [辅助计算指标](#4-辅助计算指标)
5. [衍生中间指标](#5-衍生中间指标)
6. [环比增长指标](#6-环比增长指标)
7. [统计类指标](#7-统计类指标)
8. [对比分析指标](#8-对比分析指标)
9. [结构分析指标](#9-结构分析指标)
10. [分布占比指标](#10-分布占比指标)
11. [健康度评分指标](#11-健康度评分指标)
12. [综合成本率指标](#12-综合成本率指标)
13. [特殊指标说明](#13-特殊指标说明)
14. [数据流程全景](#14-数据流程全景)
15. [架构层级与职责](#15-架构层级与职责)
16. [指标分类汇总](#16-指标分类汇总)
17. [技术实现要点](#17-技术实现要点)

---

## 1. 指标体系总览

### 1.1 指标数量统计

| 指标类别 | 数量 | 说明 |
|---------|------|------|
| **基础原始指标** | 10个 | 直接从CSV聚合,无需计算 |
| **核心展示指标** | 16个 | 4×4网格展示的KPI |
| **辅助计算指标** | 7个 | 不直接展示,用于其他指标计算 |
| **衍生中间指标** | 2个 | 满期保单件数、时间进度 |
| **环比增长指标** | 32个 | 每个核心KPI的绝对值和增长率 |
| **统计类指标** | 4个 | 风险数量统计 |
| **对比分析指标** | 4个 | 机构/业务类型排名和记录数 |
| **结构分析指标** | 5个 | 险种维度分析 |
| **分布占比指标** | 4个 | 客户/渠道占比 |
| **健康度评分指标** | 8个 | 雷达图标准化评分 |
| **综合成本率指标** | 1个 | 阈值体系特定指标 |
| **总计** | **93个** | 独立计算指标(不含环比为61个) |

### 1.2 指标体系架构图

```
CSV原始数据 (10个基础字段)
    ↓
数据聚合层 (DataService)
    ↓
    ├─→ 核心KPI计算 (16个) ─→ 4×4网格展示
    ├─→ 辅助指标计算 (7个) ─→ 供其他计算使用
    ├─→ 衍生指标计算 (2个) ─→ 满期保单件数等
    ├─→ 环比计算 (32个) ─→ 趋势分析
    ├─→ 统计类计算 (4个) ─→ 风险预警
    ├─→ 对比分析 (4个) ─→ 维度排名
    ├─→ 结构分析 (5个) ─→ 险种占比
    ├─→ 分布分析 (4个) ─→ 客户/渠道
    ├─→ 健康度评分 (8个) ─→ 雷达图
    └─→ 综合成本率 (1个) ─→ 阈值体系
         ↓
UI可视化层 (Components)
    ├─→ 驾驶舱页面
    ├─→ 专题分析页面
    ├─→ 目标管理页面
    └─→ 各类图表组件
```

---

## 2. 基础原始指标

### 2.1 定义与来源

**数据源**: CSV文件上传后直接读取的字段
**处理方式**: 仅进行聚合(SUM/COUNT),无需额外计算
**代码位置**: [src/domain/entities/InsuranceRecord.ts](src/domain/entities/InsuranceRecord.ts)

### 2.2 指标清单

| 序号 | 指标名称 | CSV字段名 | 数据类型 | 聚合方式 | 业务含义 |
|------|---------|-----------|---------|---------|---------|
| 1 | 签单保费 | `signed_premium_yuan` | Number | SUM | 新签订保单的保费收入 |
| 2 | 满期保费 | `matured_premium_yuan` | Number | SUM | 已满期保单的保费金额 |
| 3 | 保单件数 | `policy_count` | Integer | SUM | 保单总数量 |
| 4 | 赔案件数 | `claim_case_count` | Integer | SUM | 发生赔付的案件数量 |
| 5 | 已报告赔款 | `reported_claim_payment_yuan` | Number | SUM | 已上报的赔付金额 |
| 6 | 费用金额 | `expense_amount_yuan` | Number | SUM | 业务相关的总费用 |
| 7 | 商业险折前保费 | `commercial_premium_before_discount_yuan` | Number | SUM | 商业险打折前的保费 |
| 8 | 边际贡献额 | `marginal_contribution_amount_yuan` | Number | SUM | CSV中预计算的边贡额 |
| 9 | 保费计划 | `premium_plan_yuan` | Number | SUM | 预设的保费目标(可选) |
| 10 | 周序号 | `week_number` | Integer | - | 时间维度标识(28-41) |

### 2.3 数据验证规则

**类型验证**:
- 金额字段: 必须为非负数(边际贡献额除外,可为负)
- 数量字段: 必须为非负整数
- 周序号: 必须在28-41范围内

**完整性验证**:
- 必填字段: 签单保费、保单件数、周序号
- 可选字段: 保费计划、边际贡献额

**代码实现**: [src/lib/schema/insurance.ts](src/lib/schema/insurance.ts) (Zod验证)

---

## 3. 核心展示指标 - 4×4网格

### 3.1 布局说明

核心展示指标采用**4×4网格布局**,按业务逻辑分为四个横行:
- **第一行**: 核心比率指标(盈利能力、进度、成本)
- **第二行**: 核心金额指标(绝对值贡献)
- **第三行**: 结构与效率指标
- **第四行**: 单均质量指标

### 3.2 第一行: 核心比率指标

#### 3.2.1 满期边际贡献率

| 属性 | 值 |
|------|---|
| **英文名** | Contribution Margin Ratio |
| **Domain字段** | `contributionMarginRatio` |
| **Types字段** | `contribution_margin_ratio` |
| **计算公式** | `100% - 变动成本率` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 正向指标(越高越好) |
| **业务含义** | 盈利能力核心指标,反映每100元满期保费的净剩余 |
| **网格位置** | 第1行第1列 |
| **颜色编码** | 绿色系(优秀) → 红色系(差) |
| **代码位置** | [src/domain/rules/kpi-calculator-enhanced.ts:calculateContributionMarginRatio](src/domain/rules/kpi-calculator-enhanced.ts) |

**计算依赖**:
```typescript
变动成本率 = 满期赔付率 + 费用率
满期边际贡献率 = 100% - 变动成本率
```

**阈值标准**:
- 优秀: ≥ 15%
- 良好: 10% - 15%
- 健康: 5% - 10%
- 预警: 0% - 5%
- 危险: < 0%

---

#### 3.2.2 保费时间进度达成率

| 属性 | 值 |
|------|---|
| **英文名** | Premium Time Progress Achievement Rate |
| **Domain字段** | `premiumTimeProgressAchievementRate` |
| **Types字段** | `premium_time_progress_achievement_rate` |
| **计算公式** | 见下方双模式说明 |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 正向指标(越高越好) |
| **业务含义** | 衡量保费收入与年度目标的匹配程度 |
| **网格位置** | 第1行第2列 |
| **特殊说明** | 采用50周工作制(扣除春节、国庆各1周) |

**计算模式**:

**模式A: 当周值模式(累计视角)**
```typescript
时间进度 = Min(当前周次 / 50, 100%)
保费时间进度达成率 = (实际签单保费累计 / 年度目标保费) / 时间进度 × 100%
```

**示例**:
- 年度目标: 10,000万元
- 当前周次: 第25周 → 时间进度 = 50%
- 实际累计保费: 5,500万元 → 完成率 = 55%
- **达成率 = 55% / 50% = 110%**

**模式B: 周增量模式(单周视角)**
```typescript
周计划 = 年度目标保费 / 50
保费时间进度达成率 = 当周实际签单保费 / 周计划 × 100%
```

**示例**:
- 年度目标: 10,000万元
- 周计划: 200万元
- 当周实际保费: 220万元
- **达成率 = 220 / 200 = 110%**

**目标数据源**:
- 全局目标: UI输入或默认值
- 机构目标: [src/data/reference/year-plans.json](src/data/reference/year-plans.json)

**阈值标准**:
- 优秀: ≥ 120%
- 良好: 100% - 120%
- 健康: 80% - 100%
- 预警: 60% - 80%
- 危险: < 60%

---

#### 3.2.3 满期赔付率

| 属性 | 值 |
|------|---|
| **英文名** | Loss Ratio |
| **Domain字段** | `lossRatio` |
| **Types字段** | `loss_ratio` |
| **计算公式** | `已报告赔款 / 满期保费 × 100%` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 反映赔付支出占满期保费的比例,核心风险成本指标 |
| **网格位置** | 第1行第3列 |
| **颜色编码** | 红色系(高风险) → 绿色系(低风险) |

**计算逻辑**:
```typescript
if (满期保费 > 0) {
  满期赔付率 = (已报告赔款 / 满期保费) × 100
} else {
  满期赔付率 = null  // 无满期保费时无法计算
}
```

**阈值标准**:
- 优秀: ≤ 50%
- 良好: 50% - 60%
- 健康: 60% - 70%
- 预警: 70% - 80%
- 危险: > 80%

---

#### 3.2.4 费用率

| 属性 | 值 |
|------|---|
| **英文名** | Expense Ratio |
| **Domain字段** | `expenseRatio` |
| **Types字段** | `expense_ratio` |
| **计算公式** | `费用金额 / 签单保费 × 100%` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 衡量获取和管理业务所需成本的效率 |
| **网格位置** | 第1行第4列 |

**计算逻辑**:
```typescript
if (签单保费 > 0) {
  费用率 = (费用金额 / 签单保费) × 100
} else {
  费用率 = null
}
```

**阈值标准**:
- 优秀: ≤ 20%
- 良好: 20% - 25%
- 健康: 25% - 30%
- 预警: 30% - 35%
- 危险: > 35%

---

### 3.3 第二行: 核心金额指标

#### 3.3.1 满期边际贡献额

| 属性 | 值 |
|------|---|
| **Domain字段** | `contributionMarginAmount` |
| **Types字段** | `contribution_margin_amount` |
| **计算公式** | `满期保费 × 满期边际贡献率` |
| **单位** | 万元 |
| **小数位数** | 0-2位 |
| **指标类型** | 中性指标 |
| **业务含义** | 利润的绝对值贡献,定位盈利来源 |
| **网格位置** | 第2行第1列 |

**计算逻辑**:
```typescript
满期边际贡献额 = (满期保费 / 10000) × (满期边际贡献率 / 100)
```

---

#### 3.3.2 签单保费

| 属性 | 值 |
|------|---|
| **Domain字段** | `signedPremium` |
| **Types字段** | `signed_premium` |
| **计算公式** | `SUM(签单保费) / 10000` |
| **单位** | 万元 |
| **小数位数** | 0-2位 |
| **指标类型** | 中性指标 |
| **业务含义** | 业务规模的核心体现 |
| **网格位置** | 第2行第2列 |

---

#### 3.3.3 已报告赔款

| 属性 | 值 |
|------|---|
| **Domain字段** | `reportedClaimPayment` |
| **Types字段** | `reported_claim_payment` |
| **计算公式** | `SUM(已报告赔款) / 10000` |
| **单位** | 万元 |
| **小数位数** | 0-2位 |
| **指标类型** | 中性指标 |
| **业务含义** | 已发生并上报的赔案金额 |
| **网格位置** | 第2行第3列 |

---

#### 3.3.4 费用额

| 属性 | 值 |
|------|---|
| **Domain字段** | `expenseAmount` |
| **Types字段** | `expense_amount` |
| **计算公式** | `SUM(费用金额) / 10000` |
| **单位** | 万元 |
| **小数位数** | 0-2位 |
| **指标类型** | 中性指标 |
| **业务含义** | 业务相关的总费用支出 |
| **网格位置** | 第2行第4列 |

---

### 3.4 第三行: 结构与效率指标

#### 3.4.1 变动成本率

| 属性 | 值 |
|------|---|
| **Domain字段** | `variableCostRatio` |
| **Types字段** | `variable_cost_ratio` |
| **计算公式** | `满期赔付率 + 费用率` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 成本控制能力核心指标,诊断成本端的整体表现 |
| **网格位置** | 第3行第1列 |
| **⚠️ 重要说明** | 率值必须基于绝对值聚合,不能简单将分子相加 |

**正确计算逻辑**:
```typescript
// ✅ 正确: 基于绝对值聚合
满期赔付率 = (已报告赔款 / 满期保费) × 100%
费用率 = (费用金额 / 签单保费) × 100%
变动成本率 = 满期赔付率 + 费用率

// ❌ 错误: 简单的分子相加
变动成本率 ≠ (已报告赔款 + 费用金额) / 单一分母
// 因为满期赔付率和费用率的分母不同!
```

**阈值标准**:
- 优秀: ≤ 85%
- 良好: 85% - 90%
- 健康: 90% - 95%
- 预警: 95% - 100%
- 危险: > 100%

---

#### 3.4.2 满期率

| 属性 | 值 |
|------|---|
| **Domain字段** | `maturityRatio` |
| **Types字段** | `maturity_ratio` |
| **计算公式** | `满期保费 / 签单保费 × 100%` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 正向指标(越高越好) |
| **业务含义** | 反映当期保费中已实现风险价值的部分 |
| **网格位置** | 第3行第2列 |

**阈值标准**:
- 优秀: ≥ 90%
- 良好: 80% - 90%
- 健康: 70% - 80%
- 预警: 60% - 70%
- 危险: < 60%

---

#### 3.4.3 满期出险率

| 属性 | 值 |
|------|---|
| **Domain字段** | `maturedClaimRatio` |
| **Types字段** | `matured_claim_ratio` |
| **计算公式(当前)** | `赔案件数 / 保单件数 × 100%` |
| **计算公式(建议)** | `赔案件数 / (保单件数 × 满期率) × 100%` |
| **单位** | 百分比(%) |
| **小数位数** | 1-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 衡量已满期保单的出险频率 |
| **网格位置** | 第3行第3列 |
| **⚠️ 注意** | 当前实现使用保单件数,更精确应使用满期保单件数 |

**阈值标准**:
- 优秀: ≤ 30%
- 良好: 30% - 40%
- 健康: 40% - 50%
- 预警: 50% - 60%
- 危险: > 60%

---

#### 3.4.4 保单件数

| 属性 | 值 |
|------|---|
| **Domain字段** | `policyCount` |
| **Types字段** | `policy_count` |
| **计算公式** | `SUM(保单件数)` |
| **单位** | 件 |
| **小数位数** | 0位(整数) |
| **指标类型** | 中性指标 |
| **业务含义** | 业务规模的辅助指标 |
| **网格位置** | 第3行第4列 |

---

### 3.5 第四行: 单均质量指标

#### 3.5.1 赔案件数

| 属性 | 值 |
|------|---|
| **Domain字段** | `claimCaseCount` |
| **Types字段** | `claim_case_count` |
| **计算公式** | `SUM(赔案件数)` |
| **单位** | 件 |
| **小数位数** | 0位(整数) |
| **指标类型** | 中性指标 |
| **业务含义** | 赔付发生的频率 |
| **网格位置** | 第4行第1列 |

---

#### 3.5.2 单均保费

| 属性 | 值 |
|------|---|
| **Domain字段** | `averagePremium` |
| **Types字段** | `average_premium` |
| **计算公式** | `签单保费 / 保单件数` |
| **单位** | 元 |
| **小数位数** | 0-2位 |
| **指标类型** | 正向指标(越高越好) |
| **业务含义** | 业务质量指标,衡量平均每张保单的保费收入 |
| **网格位置** | 第4行第2列 |

**计算逻辑**:
```typescript
if (保单件数 > 0) {
  单均保费 = (签单保费 × 10000) / 保单件数
} else {
  单均保费 = null
}
```

**阈值标准**:
- 优秀: ≥ 3000元
- 良好: 2500 - 3000元
- 健康: 2000 - 2500元
- 预警: 1500 - 2000元
- 危险: < 1500元

---

#### 3.5.3 案均赔款

| 属性 | 值 |
|------|---|
| **Domain字段** | `averageClaim` |
| **Types字段** | `average_claim` |
| **计算公式** | `已报告赔款 / 赔案件数` |
| **单位** | 元 |
| **小数位数** | 0-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 风险成本指标,衡量平均每起赔案的赔付金额 |
| **网格位置** | 第4行第3列 |

**计算逻辑**:
```typescript
if (赔案件数 > 0) {
  案均赔款 = (已报告赔款 × 10000) / 赔案件数
} else {
  案均赔款 = null
}
```

---

#### 3.5.4 单均费用

| 属性 | 值 |
|------|---|
| **Domain字段** | `averageExpense` |
| **Types字段** | `average_expense` |
| **计算公式** | `费用金额 / 保单件数` |
| **单位** | 元 |
| **小数位数** | 0-2位 |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 运营效率指标,衡量平均每张保单的费用成本 |
| **网格位置** | 第4行第4列 |

**计算逻辑**:
```typescript
if (保单件数 > 0) {
  单均费用 = (费用金额 × 10000) / 保单件数
} else {
  单均费用 = null
}
```

---

## 4. 辅助计算指标

### 4.1 定义与用途

**特征**: 不直接在主看板展示,但用于其他指标计算或特定场景
**代码位置**: [src/domain/rules/kpi-calculator-enhanced.ts](src/domain/rules/kpi-calculator-enhanced.ts)

### 4.2 指标清单

#### 4.2.1 满期保费

| 属性 | 值 |
|------|---|
| **Domain字段** | `maturedPremium` |
| **Types字段** | `matured_premium` |
| **计算方式** | 直接聚合CSV字段 |
| **单位** | 万元 |
| **用途** | 满期率、赔付率等比率指标的分母 |
| **引用位置** | 多个核心KPI计算 |

---

#### 4.2.2 商业险自主系数

| 属性 | 值 |
|------|---|
| **Domain字段** | `autonomyCoefficient` |
| **Types字段** | `autonomy_coefficient` |
| **计算公式** | `商业险保费 / 商业险折前保费 × 100%` |
| **单位** | 百分比(%) |
| **用途** | 反映商业险定价自主性 |
| **使用场景** | 定价分析专题 |

**计算逻辑**:
```typescript
// 商业险保费 = 签单保费中的商业险部分(需从原数据筛选)
if (商业险折前保费 > 0) {
  商业险自主系数 = (商业险保费 / 商业险折前保费) × 100
} else {
  商业险自主系数 = null
}
```

---

#### 4.2.3 保费达成率

| 属性 | 值 |
|------|---|
| **Domain字段** | `premiumProgress` |
| **Types字段** | `premium_progress` |
| **计算公式** | `签单保费 / 年度目标保费 × 100%` |
| **单位** | 百分比(%) |
| **用途** | 用于计算保费时间进度达成率的中间值 |
| **引用位置** | 时间进度达成率计算 |

---

#### 4.2.4 件数时间进度达成率

| 属性 | 值 |
|------|---|
| **Domain字段** | `policyCountTimeProgressAchievementRate` |
| **Types字段** | `policy_count_time_progress_achievement_rate` |
| **计算公式** | `(保单件数 / 年度件数目标) / (当前周次 / 50) × 100%` |
| **单位** | 百分比(%) |
| **用途** | 目标管理页面展示 |
| **使用场景** | 件数达成情况监控 |

---

#### 4.2.5 单均边贡额

| 属性 | 值 |
|------|---|
| **Domain字段** | `averageContribution` |
| **Types字段** | `average_contribution` |
| **计算公式** | `(边际贡献额 × 10000) / 保单件数` |
| **单位** | 元 |
| **用途** | 边贡分析专题使用 |
| **业务含义** | 判断增长是否为高质量的盈利性增长 |
| **使用场景** | 盈利质量分析 |

**计算逻辑**:
```typescript
if (保单件数 > 0) {
  单均边贡额 = (边际贡献额 × 10000) / 保单件数
} else {
  单均边贡额 = null
}
```

---

#### 4.2.6 年度保费目标

| 属性 | 值 |
|------|---|
| **Domain字段** | `annualPremiumTarget` |
| **Types字段** | `annual_premium_target` |
| **数据来源** | UI输入或year-plans.json |
| **单位** | 万元 |
| **用途** | 目标管理和达成率计算 |
| **存储位置** | TargetStore |

---

#### 4.2.7 年度件数目标

| 属性 | 值 |
|------|---|
| **Domain字段** | `annualPolicyCountTarget` |
| **Types字段** | `annual_policy_count_target` |
| **数据来源** | UI输入或配置文件 |
| **单位** | 件 |
| **用途** | 目标管理和件数达成率计算 |
| **存储位置** | TargetStore |

---

## 5. 衍生中间指标

### 5.1 满期保单件数

| 属性 | 值 |
|------|---|
| **计算公式** | `保单件数 × 满期率` |
| **单位** | 件 |
| **业务含义** | 实际已满期的保单数量 |
| **用途** | 更精确地计算满期出险率 |
| **当前状态** | 未实现,建议采用 |

**建议实现**:
```typescript
满期保单件数 = 保单件数 × (满期率 / 100)
满期出险率(改进版) = (赔案件数 / 满期保单件数) × 100%
```

**优势**:
- 更准确反映满期保单的出险情况
- 避免将未满期保单纳入出险率分母
- 符合保险业务实际

---

### 5.2 时间进度

| 属性 | 值 |
|------|---|
| **计算公式** | `MIN(当前周次 / 50, 100%)` |
| **单位** | 百分比(%) |
| **业务含义** | 基于50周工作制的年度时间进度 |
| **用途** | 计算时间进度达成率的分母 |
| **特殊说明** | 上限为100%,避免超过全年 |

**计算示例**:
- 第25周: 时间进度 = 25/50 = 50%
- 第50周: 时间进度 = 50/50 = 100%
- 第52周: 时间进度 = MIN(52/50, 100%) = 100%

---

## 6. 环比增长指标

### 6.1 定义与计算规则

**核心原则**: 无论主视图是"累计"还是"增量",环比始终对比**本周增量 vs 上周增量**

### 6.2 指标类型

每个核心KPI(共16个)都有2个环比指标:

#### 6.2.1 环比绝对增量 (16个)

| 属性 | 值 |
|------|---|
| **计算公式** | `本周值 - 上周值` |
| **单位** | 与原指标一致 |
| **显示格式** | 带正负号,带上升/下降箭头 |
| **适用对象** | 所有16个核心KPI |

**示例**:
```
签单保费环比绝对增量 = 本周签单保费 - 上周签单保费
= 1200万 - 1000万 = +200万 ↑
```

---

#### 6.2.2 环比增长率 (16个)

| 属性 | 值 |
|------|---|
| **计算公式** | `(本周值 - 上周值) / |上周值| × 100%` |
| **单位** | 百分比(%) |
| **显示格式** | 带正负号的百分比 |
| **适用对象** | 所有16个核心KPI |

**示例**:
```
签单保费环比增长率 = (1200万 - 1000万) / 1000万 × 100%
= +20.0% ↑
```

---

### 6.3 智能周期处理

**功能**: 自动跳过缺失周期,最多往前查找5周

**逻辑**:
```typescript
function findPreviousWeekData(currentWeek: number, maxLookback: number = 5) {
  for (let i = 1; i <= maxLookback; i++) {
    const targetWeek = currentWeek - i
    if (hasData(targetWeek)) {
      return getWeekData(targetWeek)
    }
  }
  return null  // 5周内未找到数据
}
```

**场景示例**:
- 当前周: 第35周
- 第34周: 无数据(节假日停业)
- 第33周: 有数据
- 系统自动对比: 第35周 vs 第33周

---

### 6.4 环比指标清单

| 核心KPI | 环比绝对增量 | 环比增长率 |
|---------|-------------|-----------|
| 满期边际贡献率 | 边际贡献率变化(百分点) | 边际贡献率增长率(%) |
| 保费时间进度达成率 | 达成率变化(百分点) | 达成率增长率(%) |
| 满期赔付率 | 赔付率变化(百分点) | 赔付率增长率(%) |
| 费用率 | 费用率变化(百分点) | 费用率增长率(%) |
| 满期边际贡献额 | 边贡额变化(万元) | 边贡额增长率(%) |
| 签单保费 | 保费变化(万元) | 保费增长率(%) |
| 已报告赔款 | 赔款变化(万元) | 赔款增长率(%) |
| 费用额 | 费用变化(万元) | 费用增长率(%) |
| 变动成本率 | 成本率变化(百分点) | 成本率增长率(%) |
| 满期率 | 满期率变化(百分点) | 满期率增长率(%) |
| 满期出险率 | 出险率变化(百分点) | 出险率增长率(%) |
| 保单件数 | 件数变化(件) | 件数增长率(%) |
| 赔案件数 | 赔案变化(件) | 赔案增长率(%) |
| 单均保费 | 单均保费变化(元) | 单均保费增长率(%) |
| 案均赔款 | 案均赔款变化(元) | 案均赔款增长率(%) |
| 单均费用 | 单均费用变化(元) | 单均费用增长率(%) |

**总计**: 32个环比指标

---

## 7. 统计类指标

### 7.1 定义与用途

**特征**: 风险数量型指标,用于快速识别异常和预警
**显示位置**: 驾驶舱统计行(4个卡片)
**代码位置**: [src/components/features/cockpit/statistics-row.tsx](src/components/features/cockpit/statistics-row.tsx)

### 7.2 指标清单

#### 7.2.1 时间进度达成率落后机构数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(机构 WHERE 时间进度达成率 < 80%)` |
| **单位** | 个 |
| **业务含义** | 识别进度落后的机构 |
| **阈值条件** | 时间进度达成率处于"预警"或"危险"状态 |
| **显示位置** | 统计行第1列 |
| **颜色编码** | 数量越多越红 |

**计算逻辑**:
```typescript
let count = 0
for (const org of organizations) {
  if (org.kpi.premiumTimeProgressAchievementRate < 80) {
    count++
  }
}
return count
```

---

#### 7.2.2 变动成本率>92%的机构数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(机构 WHERE 变动成本率 > 92%)` |
| **单位** | 个 |
| **业务含义** | 识别成本失控的机构 |
| **阈值条件** | 变动成本率 > 92%(预警线) |
| **显示位置** | 统计行第2列 |
| **预警级别** | 高风险 |

---

#### 7.2.3 满期赔付率>70%的机构数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(机构 WHERE 满期赔付率 > 70%)` |
| **单位** | 个 |
| **业务含义** | 识别赔付风险高的机构 |
| **阈值条件** | 满期赔付率 > 70%(预警线) |
| **显示位置** | 统计行第3列 |
| **预警级别** | 高风险 |

---

#### 7.2.4 满期赔付率>70%的业务类型数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(业务类型 WHERE 满期赔付率 > 70%)` |
| **单位** | 个 |
| **业务含义** | 识别赔付风险高的业务类型 |
| **阈值条件** | 满期赔付率 > 70%(预警线) |
| **显示位置** | 统计行第4列 |
| **预警级别** | 高风险 |

---

### 7.3 阈值配置

**配置文件**: [src/config/thresholds.ts](src/config/thresholds.ts)

```typescript
export const RISK_THRESHOLDS = {
  time_progress: {
    warning: 80,    // 低于80%视为落后
    danger: 60      // 低于60%视为严重落后
  },
  variable_cost_ratio: {
    warning: 92,    // 高于92%视为预警
    danger: 100     // 高于100%视为亏损
  },
  loss_ratio: {
    warning: 70,    // 高于70%视为预警
    danger: 80      // 高于80%视为高风险
  }
}
```

---

## 8. 对比分析指标

### 8.1 定义与用途

**特征**: 维度对比和排名型指标
**使用场景**: 机构对比页面、业务类型对比页面
**代码位置**: [src/hooks/use-comparison-analysis.ts](src/hooks/use-comparison-analysis.ts)

### 8.2 机构对比维度 (2个)

#### 8.2.1 机构排名

| 属性 | 值 |
|------|---|
| **计算依据** | 按满期边际贡献率降序排列 |
| **排序规则** | 遵循"从差到好"原则(贡献率低的排前面) |
| **显示内容** | 每个机构的完整KPI数据 + 排名 |
| **数据结构** | `OrganizationComparison { organization, kpi, recordCount, rank }` |
| **用途** | 快速识别表现最差和最好的机构 |

**计算逻辑**:
```typescript
const rankedOrganizations = organizations
  .sort((a, b) => sortByValue([a, b], org => org.kpi.contributionMarginRatio, 'contribution_margin_ratio'))
  .map((org, index) => ({
    ...org,
    rank: index + 1
  }))
```

---

#### 8.2.2 机构记录数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(records WHERE organization = X)` |
| **单位** | 条 |
| **业务含义** | 每个机构的数据样本量 |
| **用途** | 辅助判断数据的统计显著性 |
| **显示位置** | 机构对比表格 |

---

### 8.3 业务类型对比维度 (2个)

#### 8.3.1 业务类型排名

| 属性 | 值 |
|------|---|
| **计算依据** | 按满期边际贡献率降序排列 |
| **排序规则** | 遵循"从差到好"原则 |
| **显示内容** | 每个业务类型的完整KPI数据 + 排名 |
| **数据结构** | `BusinessTypeComparison { businessType, kpi, recordCount, rank }` |
| **用途** | 识别高风险和高盈利业务类型 |

---

#### 8.3.2 业务类型记录数

| 属性 | 值 |
|------|---|
| **计算公式** | `COUNT(records WHERE businessType = X)` |
| **单位** | 条 |
| **业务含义** | 每个业务类型的数据样本量 |
| **用途** | 辅助判断数据的统计显著性 |

---

## 9. 结构分析指标

### 9.1 定义与用途

**特征**: 险种维度的结构分析
**使用场景**: 险种结构分析、业务组合优化
**代码位置**: [src/components/features/cockpit/business-observation/StructureBarChart.tsx](src/components/features/cockpit/business-observation/StructureBarChart.tsx)

### 9.2 指标清单 (5个)

#### 9.2.1 险种签单保费

| 属性 | 值 |
|------|---|
| **计算公式** | `SUM(签单保费 WHERE 险种 = X) / 10000` |
| **单位** | 万元 |
| **分组维度** | 险种(商业险/交强险) |
| **用途** | 险种结构分析 |

---

#### 9.2.2 险种满期保费

| 属性 | 值 |
|------|---|
| **计算公式** | `SUM(满期保费 WHERE 险种 = X) / 10000` |
| **单位** | 万元 |
| **分组维度** | 险种 |
| **用途** | 险种结构分析 |

---

#### 9.2.3 险种保单件数

| 属性 | 值 |
|------|---|
| **计算公式** | `SUM(保单件数 WHERE 险种 = X)` |
| **单位** | 件 |
| **分组维度** | 险种 |
| **用途** | 险种规模对比 |

---

#### 9.2.4 险种保费占比

| 属性 | 值 |
|------|---|
| **计算公式** | `险种签单保费 / 总签单保费 × 100%` |
| **单位** | 百分比(%) |
| **分组维度** | 险种 |
| **用途** | 分析不同险种的业务占比 |
| **显示位置** | 占比分析饼图 |

**计算逻辑**:
```typescript
险种保费占比 = (险种签单保费 / 总签单保费) × 100
```

---

#### 9.2.5 险种单均保费

| 属性 | 值 |
|------|---|
| **计算公式** | `险种签单保费 / 险种保单件数` |
| **单位** | 元 |
| **分组维度** | 险种 |
| **用途** | 分析不同险种的单均价值 |
| **业务含义** | 险种的定价水平 |

---

## 10. 分布占比指标

### 10.1 定义与用途

**特征**: 客户和渠道维度的分布分析
**使用场景**: 客户结构分析、渠道贡献分析
**代码位置**: [src/components/features/distribution-pie-chart.tsx](src/components/features/distribution-pie-chart.tsx)

### 10.2 客户分布 (2个)

#### 10.2.1 客户类型保费

| 属性 | 值 |
|------|---|
| **计算公式** | `SUM(满期保费 WHERE 客户类型 = X) / 10000` |
| **单位** | 万元 |
| **分组维度** | 客户类型(11种) |
| **用途** | 客户结构分析 |
| **显示位置** | 占比分析饼图(客户模式) |

---

#### 10.2.2 客户类型占比

| 属性 | 值 |
|------|---|
| **计算公式** | `客户类型保费 / 总满期保费 × 100%` |
| **单位** | 百分比(%) |
| **分组维度** | 客户类型 |
| **用途** | 客户结构占比分析 |
| **显示位置** | 占比分析饼图 |

**计算逻辑**:
```typescript
客户类型占比 = (客户类型保费 / 总满期保费) × 100
```

---

### 10.3 渠道分布 (2个)

#### 10.3.1 渠道保费

| 属性 | 值 |
|------|---|
| **计算公式** | `SUM(满期保费 WHERE 终端来源 = X) / 10000` |
| **单位** | 万元 |
| **分组维度** | 终端来源(8种) |
| **用途** | 渠道结构分析 |
| **显示位置** | 占比分析饼图(渠道模式) |

---

#### 10.3.2 渠道占比

| 属性 | 值 |
|------|---|
| **计算公式** | `渠道保费 / 总满期保费 × 100%` |
| **单位** | 百分比(%) |
| **分组维度** | 终端来源 |
| **用途** | 渠道结构占比分析 |
| **显示位置** | 占比分析饼图 |

---

## 11. 健康度评分指标

### 11.1 定义与用途

**特征**: 标准化评分(0-100分)
**使用场景**: 多维健康度雷达图
**计算方式**: 基于原始指标的标准化转换
**代码位置**: [src/components/features/cockpit/business-observation/MultiDimensionRadar.tsx](src/components/features/cockpit/business-observation/MultiDimensionRadar.tsx)

### 11.2 评分方法

**正向指标评分**:
```typescript
score = ((value - min) / (max - min)) × 100
```

**逆向指标评分**:
```typescript
score = ((max - value) / (max - min)) × 100
```

### 11.3 指标清单 (8个)

#### 11.3.1 边际贡献率得分

| 属性 | 值 |
|------|---|
| **原始指标** | 满期边际贡献率 |
| **评分类型** | 正向评分(越高越好) |
| **参考区间** | [-20%, 30%] |
| **满分条件** | ≥ 30% |
| **零分条件** | ≤ -20% |
| **雷达图位置** | 第1维度 |

---

#### 11.3.2 时间进度达成率得分

| 属性 | 值 |
|------|---|
| **原始指标** | 保费时间进度达成率 |
| **评分类型** | 正向评分 |
| **参考区间** | [0%, 200%] |
| **满分条件** | ≥ 200% |
| **零分条件** | ≤ 0% |
| **雷达图位置** | 第2维度 |

---

#### 11.3.3 赔付率得分 (逆向)

| 属性 | 值 |
|------|---|
| **原始指标** | 满期赔付率 |
| **评分类型** | 逆向评分(越低越好) |
| **参考区间** | [0%, 100%] |
| **满分条件** | ≤ 0% |
| **零分条件** | ≥ 100% |
| **雷达图位置** | 第3维度 |

---

#### 11.3.4 费用率得分 (逆向)

| 属性 | 值 |
|------|---|
| **原始指标** | 费用率 |
| **评分类型** | 逆向评分 |
| **参考区间** | [0%, 50%] |
| **满分条件** | ≤ 0% |
| **零分条件** | ≥ 50% |
| **雷达图位置** | 第4维度 |

---

#### 11.3.5 变动成本率得分 (逆向)

| 属性 | 值 |
|------|---|
| **原始指标** | 变动成本率 |
| **评分类型** | 逆向评分 |
| **参考区间** | [70%, 120%] |
| **满分条件** | ≤ 70% |
| **零分条件** | ≥ 120% |
| **雷达图位置** | 第5维度 |

---

#### 11.3.6 满期率得分

| 属性 | 值 |
|------|---|
| **原始指标** | 满期率 |
| **评分类型** | 正向评分 |
| **参考区间** | [0%, 100%] |
| **满分条件** | ≥ 100% |
| **零分条件** | ≤ 0% |
| **雷达图位置** | 第6维度 |

---

#### 11.3.7 单均保费得分

| 属性 | 值 |
|------|---|
| **原始指标** | 单均保费 |
| **评分类型** | 正向评分 |
| **参考区间** | [0元, 5000元] |
| **满分条件** | ≥ 5000元 |
| **零分条件** | ≤ 0元 |
| **雷达图位置** | 第7维度 |

---

#### 11.3.8 综合健康度得分

| 属性 | 值 |
|------|---|
| **计算公式** | 所有维度得分的加权平均 |
| **权重分配** | 可配置,默认均等权重 |
| **满分** | 100分 |
| **用途** | 整体健康度评估 |
| **显示位置** | 雷达图中心标注 |

**计算逻辑**:
```typescript
综合健康度得分 = (
  边际贡献率得分 × w1 +
  时间进度达成率得分 × w2 +
  赔付率得分 × w3 +
  费用率得分 × w4 +
  变动成本率得分 × w5 +
  满期率得分 × w6 +
  单均保费得分 × w7
) / (w1 + w2 + w3 + w4 + w5 + w6 + w7)
```

---

## 12. 综合成本率指标

### 12.1 定义

| 属性 | 值 |
|------|---|
| **英文名** | Combined Ratio |
| **Domain字段** | `combinedRatio` |
| **Types字段** | `combined_ratio` |
| **计算公式** | `变动成本率` 或 `(已报告赔款 + 费用金额) / 保费收入 × 100%` |
| **单位** | 百分比(%) |
| **指标类型** | 逆向指标(越低越好) |
| **业务含义** | 综合衡量赔付和费用的总成本水平 |
| **使用场景** | 阈值体系、综合风险评估 |

### 12.2 阈值标准

| 级别 | 阈值范围 | 颜色 | 业务状态 |
|------|---------|------|---------|
| **优秀** | < 90% | 深绿 #059669 | 盈利能力强 |
| **良好** | 90% - 95% | 浅绿 #10b981 | 盈利健康 |
| **健康** | 95% - 100% | 黄色 #f59e0b | 收支平衡 |
| **预警** | 100% - 105% | 橙色 #f97316 | 轻微亏损 |
| **危险** | > 105% | 红色 #ef4444 | 严重亏损 |

### 12.3 配置位置

**代码位置**: [src/config/thresholds.ts](src/config/thresholds.ts)

```typescript
export const COMBINED_RATIO_THRESHOLDS = {
  excellent: { max: 90, color: '#059669' },
  good: { min: 90, max: 95, color: '#10b981' },
  healthy: { min: 95, max: 100, color: '#f59e0b' },
  warning: { min: 100, max: 105, color: '#f97316' },
  danger: { min: 105, color: '#ef4444' }
}
```

---

## 13. 特殊指标说明

### 13.1 满期保单件数的计算问题

#### 13.1.1 当前实现

```typescript
满期出险率 = 赔案件数 / 保单件数 × 100%
```

**问题**: 使用全部保单件数作为分母,包含了未满期保单

#### 13.1.2 建议改进

**方法一: 基于满期率计算**
```typescript
满期保单件数 = 保单件数 × 满期率
满期出险率 = 赔案件数 / 满期保单件数 × 100%
```

**方法二: 基于满期保费反推**
```typescript
满期保单件数 = 满期保费 / 单均保费
满期出险率 = 赔案件数 / 满期保单件数 × 100%
```

**优势**:
- 更准确反映满期保单的出险情况
- 避免将未满期保单纳入分母
- 符合保险业务实际

**实现建议**:
1. 在Domain层新增 `calculateMaturedPolicyCount()` 函数
2. 修改 `calculateMaturedClaimRatio()` 使用新的分母
3. 更新相关测试用例

---

### 13.2 变动成本率的正确计算

#### 13.2.1 错误做法

```typescript
// ❌ 错误: 简单的分子相加
变动成本率 = (已报告赔款 + 费用金额) / 单一分母 × 100%
```

**问题**: 满期赔付率和费用率的分母不同!

#### 13.2.2 正确做法

```typescript
// ✅ 正确: 基于绝对值聚合
满期赔付率 = (已报告赔款 / 满期保费) × 100%
费用率 = (费用金额 / 签单保费) × 100%
变动成本率 = 满期赔付率 + 费用率
```

**关键点**:
- 满期赔付率分母: 满期保费
- 费用率分母: 签单保费
- 两者分母不同,不能简单相加

**代码位置**: [src/domain/rules/kpi-calculator-enhanced.ts:calculateVariableCostRatio](src/domain/rules/kpi-calculator-enhanced.ts)

---

### 13.3 环比计算的特殊逻辑

#### 13.3.1 核心原则

**始终对比增量**: 无论主视图是"累计"还是"增量",环比始终对比**本周增量 vs 上周增量**

#### 13.3.2 为什么不对比累计值?

**累计值环比问题**:
```
Week 10累计保费: 10,000万
Week 9累计保费: 9,000万
累计值环比 = (10,000 - 9,000) / 9,000 = +11.1%
```

**问题**: 仅反映存量增长,无法体现业绩波动

**增量值环比(推荐)**:
```
Week 10增量保费: 1,000万
Week 9增量保费: 800万
增量环比 = (1,000 - 800) / 800 = +25.0%
```

**优势**: 准确反映本周业绩变化

---

## 14. 数据流程全景

### 14.1 七阶段数据流

```
阶段1: 数据上传与解析
   ↓
阶段2: 数据存储与持久化
   ↓
阶段3: 数据筛选与过滤
   ↓
阶段4: KPI计算
   ↓
阶段5: 多维度分析
   ↓
阶段6: UI可视化展示
   ↓
阶段7: 交互与导出
```

### 14.2 阶段一: 数据上传与解析

**流程入口**:
- [src/components/features/file-upload.tsx](src/components/features/file-upload.tsx)

**核心组件**:
- 解析服务: [src/domain/services/csv-parser-service.ts](src/domain/services/csv-parser-service.ts)
- 上传Hook: [src/hooks/use-file-upload.ts](src/hooks/use-file-upload.ts)

**解析过程**:
1. **流式解析**: 使用Papa Parse分块处理CSV(避免内存溢出)
2. **实时验证**:
   - 字段数量验证(27或26个字段)
   - 字段顺序验证
   - 数据类型验证(Zod Schema)
   - 枚举值验证
3. **智能纠错**:
   - 模糊匹配已知枚举值变体
   - 自动修正常见错误
   - 例如: "10吨以上-普货" → "10吨以上营业货车(普货)"
4. **错误收集**:
   - 收集验证失败的行
   - 提供详细错误信息(行号、字段、原因、修复建议)

**支持特性**:
- 拖拽上传或点击上传
- 最大支持200MB文件
- 实时显示解析进度

---

### 14.3 阶段二: 数据存储与持久化

**数据规范化**:
- CSV数据 → `InsuranceRecord` 实体对象

**存储层级**:

**内存存储 (Zustand)**:
- DataStore: [src/store/domains/dataStore.ts](src/store/domains/dataStore.ts)
- 提供数据的增删改查操作

**本地持久化 (LocalStorage)**:
- 服务: [src/services/PersistenceService.ts](src/services/PersistenceService.ts)
- 适配器: [src/services/adapters/LocalStorageAdapter.ts](src/services/adapters/LocalStorageAdapter.ts)
- 功能:
  - 自动保存上传成功的数据
  - 页面刷新时自动恢复数据
  - 维护上传历史记录
  - 基于文件哈希值去重

**数据去重**:
- 基于文件哈希值进行去重
- 追加上传时自动合并并去重
- 保留最新版本的数据

---

### 14.4 阶段三: 数据筛选与过滤

**筛选器系统**:
- FilterStore: [src/store/domains/filterStore.ts](src/store/domains/filterStore.ts)

**支持维度 (9个)**:
1. 年份 (`policy_start_year`)
2. 周次范围 (`week_number`)
3. 三级机构 (`third_level_organization`)
4. 业务类型 (`business_type_category`)
5. 客户类型 (`customer_category_3`)
6. 保险类型 (`insurance_type`)
7. 新能源车 (`is_new_energy_vehicle`)
8. 险别组合 (`coverage_type`)
9. 终端来源 (`terminal_source`)

**筛选实现**:
- 核心服务: [src/services/DataService.ts](src/services/DataService.ts)
- 提供统一的 `filter()` 方法
- 支持筛选联动(动态更新可用选项)
- 支持筛选条件持久化

**应用层Hook**:
- `useInsuranceData`: 聚合原始数据和筛选条件
- `useFiltering`: 管理筛选状态和操作

---

### 14.5 阶段四: KPI计算

**计算引擎**:
- 核心规则: [src/domain/rules/kpi-calculator-enhanced.ts](src/domain/rules/kpi-calculator-enhanced.ts)
- 计算服务: [src/services/KPIService.ts](src/services/KPIService.ts)

**计算流程**:

**步骤1: 数据聚合**
```typescript
InsuranceRecord[] → AggregatedData {
  签单保费: SUM(signed_premium_yuan),
  满期保费: SUM(matured_premium_yuan),
  保单件数: SUM(policy_count),
  赔案件数: SUM(claim_case_count),
  已报告赔款: SUM(reported_claim_payment_yuan),
  费用金额: SUM(expense_amount_yuan)
}
```

**步骤2: 率值计算**
```typescript
满期赔付率 = 已报告赔款 / 满期保费 × 100%
费用率 = 费用金额 / 签单保费 × 100%
满期率 = 满期保费 / 签单保费 × 100%
满期出险率 = 赔案件数 / 保单件数 × 100%
```

**步骤3: 组合计算**
```typescript
变动成本率 = 满期赔付率 + 费用率
满期边际贡献率 = 100% - 变动成本率
满期边际贡献额 = 满期保费 × 满期边际贡献率
```

**步骤4: 均值计算**
```typescript
单均保费 = 签单保费 / 保单件数
案均赔款 = 已报告赔款 / 赔案件数
单均费用 = 费用金额 / 保单件数
```

**步骤5: 达成率计算 (50周工作制)**
```typescript
时间进度 = 当前周次 / 50
保费达成率 = 实际签单保费 / 年度目标保费 × 100%
保费时间进度达成率 = 保费达成率 / 时间进度 × 100%
```

**计算模式**:
- **当周值模式(累计视角)**: 计算截至当前周的累计数据
- **周增量模式(单周视角)**: 仅计算当周发生的增量数据

**环比计算**:
- 无论主视图是累计还是增量,环比始终对比**本周增量 vs 上周增量**
- 公式: `(本周数值 - 上周数值) / |上周数值| × 100%`
- 智能跳过缺失周期(最多往前查找5周)

**应用层Hook**:
- `useKPICalculation`: 基于筛选后的数据计算KPI
- `use-kpi.ts`: 提供智能对比功能(当周 vs 上周)
- `use-kpi-trend.ts`: 计算趋势数据

---

### 14.6 阶段五: 多维度分析

**维度下钻**:
- 核心组件: [src/components/features/drill-down/](src/components/features/drill-down/)

**支持维度 (9个)**:
1. 三级机构
2. 业务类型
3. 客户类型
4. 保险类型
5. 新能源属性
6. 险别组合
7. 过户属性
8. 新续转状态
9. 终端来源

**下钻导航**:
- 全局下钻导航条(面包屑)
- 显示当前下钻路径
- 支持快速返回上级或清除下钻

**维度对比分析**:
- 按指定维度分组计算KPI
- 自动排序(遵循"从差到好"规范)
- 支持多维度交叉分析

**分析服务**:
- `DataService.groupBy`: 按维度分组数据
- `KPIService.calculateByDimension`: 批量计算各维度的KPI
- `sortByValue`: 智能排序函数(自动识别正向/逆向指标)

---

### 14.7 阶段六: UI可视化展示

**主要展示页面**:

**1. 企业驾驶舱** ([src/app/page.tsx](src/app/page.tsx))
- KPI概览卡片(4×4网格 或 紧凑模式)
- 统计概览行(保费、件数、赔案等)
- 业务观察模块:
  - 时间进度分析
  - 成本风险分析
  - 业务健康热力图
  - 多维健康度雷达图
  - 占比分析饼图
  - 动态对比条形图

**2. 专题分析页面**
- 边贡分析专题
- 保费分析专题
- 赔付分析专题

**3. 目标管理页面** ([src/app/targets/page.tsx](src/app/targets/page.tsx))
- 年度保费目标设置
- 四个维度的目标拆分:
  - 业务类型
  - 三级机构
  - 客户分类
  - 保险类型
- 支持CSV导入/导出目标
- 版本管理和历史快照

**核心可视化组件**:

**KPI卡片系列**:
- `kpi-card.tsx`: 基础KPI卡片(指标值、环比、趋势)
- `kpi-card-with-drilldown.tsx`: 支持下钻的KPI卡片
- `compact-kpi-card.tsx`: 紧凑版KPI卡片

**图表组件系列**:
- `multi-dimension-radar.tsx`: 多维雷达图(健康度)
- `structure-bar-chart.tsx`: 结构分析条形图
- `dimension-bar-chart.tsx`: 维度对比条形图
- `business-type-heatmap.tsx`: 业务类型热力图
- `distribution-pie-chart.tsx`: 分布饼图
- `weekly-operational-trend/`: 周度经营趋势折线图

**图表技术栈**:
- ECharts 5.x(统一可视化引擎)
- 基础组件: `BaseEChart.tsx`(封装通用配置)
- 统一配色方案(5级阈值体系)
- 响应式布局

**颜色编码规则**:
- **正向指标**: 越高越好,绿色系表示优秀
- **逆向指标**: 越低越好,红色系表示风险
- **中性指标**: 通常使用灰色系
- **5级阈值体系**:
  - 极差: 红色 #ef4444
  - 较差: 橙色 #f97316
  - 一般: 黄色 #f59e0b
  - 良好: 浅绿 #10b981
  - 优秀: 深绿 #059669

**显示格式**:
- **比率**: 保留1-2位小数的百分比
- **金额**: 以"万"为单位,保留0-2位小数
- **数量**: 整数
- **环比变化**: 显示绝对增量和百分比,带箭头

---

### 14.8 阶段七: 交互与导出

**交互功能**:
1. 卡片点击下钻
2. 图表联动筛选
3. 趋势图时间范围选择
4. 多周同时导入
5. 筛选器联动更新

**数据导出**:
- 核心组件: [src/components/features/data-export.tsx](src/components/features/data-export.tsx)

**支持格式**:
1. CSV(原始数据)
2. JSON(结构化数据)
3. Excel(格式化报表)
4. PDF(可视化报告)

**导出范围**:
1. 当前筛选数据
2. KPI汇总数据
3. 图表截图

---

## 15. 架构层级与职责

### 15.1 五层架构

```
展示层 (Components & Pages)
    ↓
应用层 (Domain-specific Hooks)
    ↓
状态层 (Domain Stores)
    ↓
服务层 (Business Services)
    ↓
基础设施层 (Adapters & Interfaces)
```

### 15.2 各层职责

#### 15.2.1 展示层 (Components & Pages)

**职责**: 纯渲染,无业务逻辑
**通过**: Props和Custom Hooks获取数据
**代码位置**: [src/components/](src/components/), [src/app/](src/app/)

**示例组件**:
```typescript
// KPI卡片组件
export function KPICard({ metric, value, change }: KPICardProps) {
  return (
    <div className="kpi-card">
      <div className="metric-name">{metric}</div>
      <div className="metric-value">{value}</div>
      <div className="metric-change">{change}</div>
    </div>
  )
}
```

---

#### 15.2.2 应用层 (Domain-specific Hooks)

**职责**: 聚合领域状态,提供业务接口
**代码位置**: [src/hooks/](src/hooks/)

**核心Hook**:
- `useInsuranceData`: 聚合数据管理
- `useKPICalculation`: KPI计算封装
- `useFiltering`: 筛选状态管理
- `useOrganizationKPI`: 机构维度KPI
- `useSmartComparison`: 智能对比分析

**示例Hook**:
```typescript
export function useKPICalculation() {
  const records = useInsuranceData()
  const filters = useFilters()

  const filteredRecords = useMemo(
    () => DataService.filter(records, filters),
    [records, filters]
  )

  const kpi = useMemo(
    () => KPIService.calculate(filteredRecords),
    [filteredRecords]
  )

  return kpi
}
```

---

#### 15.2.3 状态层 (Domain Stores)

**职责**: 管理状态,调用Service处理业务
**技术**: Zustand
**代码位置**: [src/store/domains/](src/store/domains/)

**核心Store**:
- `DataStore`: 原始数据管理
- `FilterStore`: 筛选条件管理
- `TargetStore`: 目标管理
- `CacheStore`: 计算结果缓存
- `UIStore`: UI状态管理

**示例Store**:
```typescript
export const useDataStore = create<DataStore>((set, get) => ({
  records: [],

  addRecords: (newRecords) => {
    const updated = DataService.merge(
      get().records,
      newRecords
    )
    set({ records: updated })
  },

  clearRecords: () => set({ records: [] })
}))
```

---

#### 15.2.4 服务层 (Business Services)

**职责**: 纯函数,无状态,可独立测试
**代码位置**: [src/services/](src/services/), [src/domain/rules/](src/domain/rules/)

**核心服务**:
- `DataService`: 数据CRUD、过滤聚合
- `KPIService`: KPI计算引擎
- `PersistenceService`: 持久化抽象层
- `CSVParserService`: CSV解析服务

**示例服务**:
```typescript
export class KPIService {
  static calculate(records: InsuranceRecord[]): KPIResult {
    const aggregated = this.aggregate(records)
    return calculateKPIs(aggregated)
  }

  static aggregate(records: InsuranceRecord[]): AggregatedData {
    return {
      signedPremium: sum(records, r => r.signed_premium_yuan),
      policyCount: sum(records, r => r.policy_count),
      // ...
    }
  }
}
```

---

#### 15.2.5 基础设施层 (Adapters & Interfaces)

**职责**: 技术实现,可替换
**代码位置**: [src/services/adapters/](src/services/adapters/)

**核心接口与实现**:
- `IPersistenceAdapter`: 持久化接口
- `LocalStorageAdapter`: LocalStorage实现
- 未来可扩展: `IndexedDBAdapter`, `CloudStorageAdapter`

**示例适配器**:
```typescript
export class LocalStorageAdapter implements IPersistenceAdapter {
  save(key: string, data: any): void {
    localStorage.setItem(key, JSON.stringify(data))
  }

  load(key: string): any {
    const raw = localStorage.getItem(key)
    return raw ? JSON.parse(raw) : null
  }
}
```

---

### 15.3 数据流向

```
CSV文件
  ↓ 流式解析 (Papa Parse)
  ↓ 数据验证 (Zod Schema)
InsuranceRecord实体
  ↓ 存储 (Zustand)
DataStore
  ↓ 持久化 (LocalStorage)
LocalStorage
  ↓ 应用筛选器 (FilterStore)
筛选后的数据
  ↓ 数据聚合 (DataService)
AggregatedData
  ↓ KPI计算 (KPIService)
KPIResult
  ↓ 缓存 (CacheStore)
缓存的KPI
  ↓ UI组件渲染 (React Components)
最终展示
```

---

### 15.4 命名约定

**双命名体系**:

| 层级 | 命名风格 | 示例 | 使用场景 |
|------|---------|------|---------|
| **Domain层** | `camelCase` | `lossRatio`, `contributionMarginRatio` | TypeScript业务逻辑 |
| **Types/数据库层** | `snake_case` | `loss_ratio`, `contribution_margin_ratio` | 数据库字段、API响应、CSV |

**转换机制**:
- 系统通过类型映射自动处理两种命名的互转
- 前端组件通常使用 `camelCase`
- 数据库/CSV导入导出使用 `snake_case`

**代码示例**:
```typescript
// Domain层
export interface KPIResult {
  lossRatio: number | null
  contributionMarginRatio: number | null
}

// Types层
export interface KPIResult {
  loss_ratio: number | null
  contribution_margin_ratio: number | null
}
```

---

## 16. 指标分类汇总

### 16.1 按数据类型分类

#### 绝对值指标 (12个)
- 签单保费、满期保费
- 保单件数、赔案件数
- 已报告赔款、费用金额
- 边际贡献额
- 单均保费、案均赔款、单均费用
- 单均边贡额
- 满期保单件数

#### 比率指标 (11个)
- 满期赔付率、费用率
- 满期率、变动成本率
- 边际贡献率、满期出险率
- 时间进度达成率、综合成本率
- 各类占比(险种、客户、渠道)

#### 计数指标 (4个)
- 风险机构数
- 风险业务类型数
- 记录数(机构、业务类型)

#### 排名指标 (2个)
- 机构排名
- 业务类型排名

#### 评分指标 (8个)
- 7个维度健康度得分
- 1个综合健康度得分

---

### 16.2 按业务用途分类

#### 盈利能力 (4个)
- 边际贡献率
- 边际贡献额
- 单均边贡额
- 变动成本率

#### 业务规模 (4个)
- 签单保费
- 保单件数
- 满期保费
- 赔案件数

#### 成本控制 (6个)
- 变动成本率
- 满期赔付率
- 费用率
- 综合成本率
- 案均赔款
- 单均费用

#### 进度管理 (3个)
- 保费时间进度达成率
- 件数时间进度达成率
- 时间进度

#### 质量效率 (5个)
- 单均保费
- 满期率
- 满期出险率
- 险种单均保费
- 商业险自主系数

#### 风险预警 (4个)
- 时间进度达成率落后机构数
- 变动成本率>92%的机构数
- 满期赔付率>70%的机构数
- 满期赔付率>70%的业务类型数

#### 结构分析 (10个)
- 险种占比(保费、件数)
- 客户占比
- 渠道占比
- 机构对比
- 业务类型对比

---

### 16.3 按展示位置分类

#### KPI卡片 (16个)
4×4网格的核心KPI

#### 统计行 (4个)
风险数量型指标

#### 图表组件 (15+个)
- 雷达图: 8个健康度评分
- 饼图: 4个占比指标
- 柱状图: 对比分析指标
- 热力图: 业务类型表现
- 折线图: 趋势分析

#### 专题分析 (10+个)
边贡分析、保费分析、赔付分析专题使用的指标

#### 目标管理 (4个)
年度目标、达成率、时间进度等

---

### 16.4 完整指标统计

| 指标类别 | 数量 | 备注 |
|---------|------|------|
| 基础原始指标 | 10个 | 直接从CSV聚合 |
| 核心展示指标 | 16个 | 4×4网格 |
| 辅助计算指标 | 7个 | 不直接展示 |
| 衍生中间指标 | 2个 | 满期保单件数、时间进度 |
| 环比增长指标 | 32个 | 每个核心KPI各2个 |
| 统计类指标 | 4个 | 风险数量 |
| 对比分析指标 | 4个 | 排名和记录数 |
| 结构分析指标 | 5个 | 险种维度 |
| 分布占比指标 | 4个 | 客户/渠道 |
| 健康度评分指标 | 8个 | 雷达图 |
| 综合成本率指标 | 1个 | 阈值体系 |
| **总计(不含环比)** | **61个** | 独立计算指标 |
| **总计(含环比)** | **93个** | 全部指标 |

---

## 17. 技术实现要点

### 17.1 性能优化

#### 17.1.1 内存管理
- 流式CSV解析,分块处理大文件(200MB+)
- 虚拟滚动(大数据表格)
- React.memo优化组件重渲染
- useMemo缓存计算结果

#### 17.1.2 计算优化
- 纯函数设计,易于优化
- 批量计算减少遍历次数
- 智能缓存避免重复计算
- 缓存键包含所有相关参数

#### 17.1.3 缓存策略

**缓存键构成**:
```typescript
{
  currentWeek: { year, weekNumber, kpi },
  previousWeek: { year, weekNumber, kpi },
  yearPlan: number | null
}
```

**缓存失效**:
- 数据变更(新增、删除、修改)
- 筛选条件变更
- 目标设置变更

---

### 17.2 错误处理

#### 17.2.1 数据验证错误
- 详细的错误报告(行号、字段、原因、建议)
- 智能纠错(枚举值模糊匹配)
- 错误分级(严重/警告/提示)

#### 17.2.2 运行时错误
- Error Boundary捕获组件错误
- 友好的错误提示
- 降级策略(数据缺失时显示默认值)

**示例**:
```typescript
try {
  const kpi = calculateKPI(data)
} catch (error) {
  console.error('KPI计算失败:', error)
  return getDefaultKPI()  // 降级策略
}
```

---

### 17.3 数据一致性保证

#### 17.3.1 单一数据源
- DataStore是唯一的数据真实来源
- 所有计算基于DataStore数据
- 避免多处维护相同数据

#### 17.3.2 不可变数据
```typescript
// ✅ 正确: 不可变更新
const updatedRecords = [...records, newRecord]

// ❌ 错误: 直接修改
records.push(newRecord)
```

#### 17.3.3 类型安全
- TypeScript严格模式
- Zod运行时验证
- 类型守卫函数

---

### 17.4 测试策略

#### 17.4.1 单元测试
- KPI计算函数测试
- 数据聚合函数测试
- 排序和筛选逻辑测试

#### 17.4.2 集成测试
- 完整数据流程测试
- 筛选器联动测试
- 环比计算测试

#### 17.4.3 边界测试
- 空数据处理
- 除零错误
- 异常值处理
- 缺失周期处理

---

## 18. 相关文档

### 18.1 核心文档

- [核心指标计算引擎 V2.0](./core_calculations.md) - KPI计算公式和业务逻辑
- [数据架构文档](./data_architecture.md) - 数据结构规范和字段定义
- [架构重构文档](./architecture_refactoring.md) - 分层架构设计
- [技术栈文档](./tech_stack.md) - 技术选型和开发环境

### 18.2 功能文档

- [数据上传功能](../01_features/feature_01_data_upload.md) - CSV上传和解析流程
- [KPI看板功能](../01_features/feature_02_kpi_dashboard.md) - 4×4网格布局
- [筛选器功能](../01_features/feature_03_filters.md) - 多维度筛选
- [目标管理功能](../01_features/feature_04_target_management.md) - 年度目标设置

### 18.3 测试文档

- [KPI看板4×4网格布局测试记录](../archive/KPI看板-4x4网格布局-测试记录.md)
- [紧凑版KPI看板测试记录 V2.0](../archive/紧凑版KPI看板测试记录-V2.md)
- [边贡分析模块改造测试记录](../archive/边贡分析模块改造测试记录.md)

---

## 19. 文档状态

- **版本**: v1.0
- **创建日期**: 2025-12-22
- **最后更新**: 2025-12-22
- **状态**: ✅ **稳定**
- **维护者**: AI
- **审阅者**: 待审阅

---

## 20. 附录

### 20.1 指标速查表

| 序号 | 指标名称 | Domain字段 | 计算公式 | 类型 |
|------|---------|-----------|---------|------|
| 1 | 满期边际贡献率 | contributionMarginRatio | 100% - 变动成本率 | 正向 |
| 2 | 保费时间进度达成率 | premiumTimeProgressAchievementRate | (签单保费/年度目标) / 时间进度 | 正向 |
| 3 | 满期赔付率 | lossRatio | 已报告赔款 / 满期保费 | 逆向 |
| 4 | 费用率 | expenseRatio | 费用金额 / 签单保费 | 逆向 |
| 5 | 满期边际贡献额 | contributionMarginAmount | 满期保费 × 边际贡献率 | 中性 |
| 6 | 签单保费 | signedPremium | SUM(签单保费) | 中性 |
| 7 | 已报告赔款 | reportedClaimPayment | SUM(已报告赔款) | 中性 |
| 8 | 费用额 | expenseAmount | SUM(费用金额) | 中性 |
| 9 | 变动成本率 | variableCostRatio | 满期赔付率 + 费用率 | 逆向 |
| 10 | 满期率 | maturityRatio | 满期保费 / 签单保费 | 正向 |
| 11 | 满期出险率 | maturedClaimRatio | 赔案件数 / 保单件数 | 逆向 |
| 12 | 保单件数 | policyCount | SUM(保单件数) | 中性 |
| 13 | 赔案件数 | claimCaseCount | SUM(赔案件数) | 中性 |
| 14 | 单均保费 | averagePremium | 签单保费 / 保单件数 | 正向 |
| 15 | 案均赔款 | averageClaim | 已报告赔款 / 赔案件数 | 逆向 |
| 16 | 单均费用 | averageExpense | 费用金额 / 保单件数 | 逆向 |

### 20.2 阈值速查表

| 指标 | 优秀 | 良好 | 健康 | 预警 | 危险 |
|------|------|------|------|------|------|
| 边际贡献率 | ≥15% | 10%-15% | 5%-10% | 0%-5% | <0% |
| 时间进度达成率 | ≥120% | 100%-120% | 80%-100% | 60%-80% | <60% |
| 满期赔付率 | ≤50% | 50%-60% | 60%-70% | 70%-80% | >80% |
| 费用率 | ≤20% | 20%-25% | 25%-30% | 30%-35% | >35% |
| 变动成本率 | ≤85% | 85%-90% | 90%-95% | 95%-100% | >100% |
| 满期率 | ≥90% | 80%-90% | 70%-80% | 60%-70% | <60% |
| 满期出险率 | ≤30% | 30%-40% | 40%-50% | 50%-60% | >60% |
| 单均保费 | ≥3000 | 2500-3000 | 2000-2500 | 1500-2000 | <1500 |
| 综合成本率 | <90% | 90%-95% | 95%-100% | 100%-105% | >105% |

### 20.3 术语表

| 术语 | 全称 | 含义 |
|------|------|------|
| KPI | Key Performance Indicator | 关键绩效指标 |
| 边际贡献率 | Contribution Margin Ratio | 盈利能力核心指标 |
| 满期保费 | Matured Premium | 已满期保单的保费 |
| 签单保费 | Signed Premium | 新签订保单的保费 |
| 赔付率 | Loss Ratio | 赔付支出占保费的比例 |
| 费用率 | Expense Ratio | 费用支出占保费的比例 |
| 变动成本率 | Variable Cost Ratio | 赔付率+费用率 |
| 50周工作制 | 50-Week System | 扣除长假的年度周数 |
| Domain层 | Domain Layer | 业务逻辑层,使用camelCase |
| Types层 | Types Layer | 数据类型层,使用snake_case |

---

**文档结束**
